{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-product-quiz-{{ ai_gen_id }} {
  width: 100%;
  padding: {{ block.settings.section_padding }}px 0;
  position: relative;
  display: flex;
  {% if block.settings.full_width %}
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;
  {% endif %}
  }

  .ai-product-quiz-container-{{ ai_gen_id }} {
  background-color: {{ block.settings.background_color }};
  display: grid;
  grid-template-columns: {{ block.settings.image_width }}% 1fr;
  gap: {{ block.settings.content_gap }}px;
  align-items: center;
  margin: 0 auto;
  padding: 0 20px;
  position: relative;
  width: 100%;
  border-radius: var(--btn-border-radius);
  }

  .ai-product-quiz-image-section-{{ ai_gen_id }} {
  position: relative;
  height: 400px;
  overflow: visible;
  }

  .ai-product-quiz-image-wrapper-{{ ai_gen_id }} {
  position: absolute;
  top: {{ block.settings.image_position_desktop_y }}%;
  left: {{ block.settings.image_position_desktop_x }}%;
  transform: translate(-50%, -50%);
  width: {{ block.settings.image_size }}px;
  z-index: 1;
  }

  .ai-product-quiz-image-{{ ai_gen_id }} {
  width: 100%;
  height: auto;
  display: block;
  }

  .ai-product-quiz-image-placeholder-{{ ai_gen_id }} {
  background-color: #f4f4f4;
  width: 100%;
  height: 300px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  }

  .ai-product-quiz-empty-state-{{ ai_gen_id }} {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 20px;
  font-size: 14px;
  color: #666;
  text-align: center;
  pointer-events: none;
  }

  .ai-product-quiz-image-placeholder-{{ ai_gen_id }} svg {
  width: 100%;
  height: 100%;
  max-width: 200px;
  max-height: 200px;
  }

  .ai-product-quiz-text-overlay-{{ ai_gen_id }} {
  position: absolute;
  top: {{ block.settings.text_position_desktop_y }}%;
  left: {{ block.settings.text_position_desktop_x }}%;
  transform: translate(-50%, -50%);
  font-size: {{ block.settings.overlay_text_size }}px;
  font-weight: {{ block.settings.overlay_text_weight }};
  color: {{ block.settings.overlay_text_color }};
  white-space: nowrap;
  pointer-events: none;
  z-index: 2;
  font-family: {{ block.settings.overlay_font.family }}, {{ block.settings.overlay_font.fallback_families }};
  font-style: {{ block.settings.overlay_font.style }};
  font-weight: {{ block.settings.overlay_font.weight }};
  }

  .ai-product-quiz-content-section-{{ ai_gen_id }} {
  padding: 40px 0;
  z-index: 3;
  position: relative;
  }

  .ai-product-quiz-subtitle-{{ ai_gen_id }} {
  font-size: {{ block.settings.subtitle_size }}px;
  color: {{ block.settings.subtitle_color }};
  margin: 0 0 8px;
  font-weight: 400;
  }

  .ai-product-quiz-title-{{ ai_gen_id }} {
  font-size: {{ block.settings.title_size }}px;
  color: {{ block.settings.title_color }};
  margin: 0 0 24px;
  font-weight: 400;
  line-height: 1.2;
  }

  .ai-product-quiz-form-wrapper-{{ ai_gen_id }} {
  position: relative;
  display: flex;
  gap: 8px;
  max-width: 400px;
  }

  .ai-product-quiz-input-{{ ai_gen_id }} {
  flex: 1;
  padding: 16px 20px;
  border: 1px solid {{ block.settings.input_border_color }}!important;
  border-radius: {{ block.settings.input_border_radius }}px;
  font-size: {{ block.settings.input_text_size }}px;
  background-color: {{ block.settings.input_background_color }};
  color: {{ block.settings.input_text_color }};
  outline: none;
  transition: border-color 0.3s ease;
  &:focus {
  box-shadow: none!important;
  outline: 2px solid {{ block.settings.input_border_color }}!important;
  }
  }

  .ai-product-quiz-input-{{ ai_gen_id }}:focus {
  border-color: {{ block.settings.input_focus_border_color }};
  }

  .ai-product-quiz-input-{{ ai_gen_id }}::placeholder {
  color: {{ block.settings.input_placeholder_color }};
  }

  .ai-product-quiz-submit-{{ ai_gen_id }} {
  padding: 16px 20px;
  background-color: {{ block.settings.button_background_color }};
  color: {{ block.settings.button_text_color }};
  border: none;
  border-radius: {{ block.settings.button_border_radius }}px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 60px;
  text-decoration: none;
  }

  .ai-product-quiz-submit-{{ ai_gen_id }}:hover {
  background-color: {{ block.settings.button_hover_background_color }};
  }

  .ai-product-quiz-submit-{{ ai_gen_id }} svg {
  width: 20px;
  height: 20px;
  }

  @media screen and (max-width: 768px) {
  .ai-product-quiz-container-{{ ai_gen_id }} {
  grid-template-columns: 1fr;
  gap: 30px;
  padding: 0 15px;
  }

  .ai-product-quiz-image-section-{{ ai_gen_id }} {
  height: 300px;
  }

  .ai-product-quiz-image-wrapper-{{ ai_gen_id }} {
  top: {{ block.settings.image_position_mobile_y }}%;
  left: {{ block.settings.image_position_mobile_x }}%;
  width: {{ block.settings.image_size | times: 0.8 }}px;
  }

  .ai-product-quiz-text-overlay-{{ ai_gen_id }} {
  top: {{ block.settings.text_position_mobile_y }}%;
  left: {{ block.settings.text_position_mobile_x }}%;
  font-size: calc({{ block.settings.overlay_text_size }}px * 0.8);
  }

  .ai-product-quiz-content-section-{{ ai_gen_id }} {
  padding: 20px 0;
  text-align: center;
  display: flex;
  flex-direction: column-reverse;
  padding-top: 0;
  }

  .ai-product-quiz-input-{{ ai_gen_id }} {

  }

  .ai-product-quiz-form-wrapper-{{ ai_gen_id }} {
  margin: 0 auto;
  max-width: 600px;
  width: 100%;
  }

  .ai-product-quiz-title-{{ ai_gen_id }} {
  font-size: calc({{ block.settings.title_size }}px * 0.9);
  margin-top: 10px;
  }

  .ai-product-quiz-subtitle-{{ ai_gen_id }} {
  font-size: calc({{ block.settings.subtitle_size }}px * 0.9);
  }
  }
{% endstyle %}

<product-quiz-{{ ai_gen_id }}
    class="ai-product-quiz-{{ ai_gen_id }}"
    {{ block.shopify_attributes }}
>
  <div class="ai-product-quiz-container-{{ ai_gen_id }}">
    <div class="ai-product-quiz-image-section-{{ ai_gen_id }}">
      <div class="ai-product-quiz-image-wrapper-{{ ai_gen_id }}">
        {% if block.settings.product_image %}
          <img
              src="{{ block.settings.product_image | image_url: width: 800 }}"
              alt="{{ block.settings.product_image.alt | escape }}"
              class="ai-product-quiz-image-{{ ai_gen_id }}"
              loading="lazy"
              width="{{ block.settings.product_image.width }}"
              height="{{ block.settings.product_image.height }}"
          >
        {% else %}
          <div class="ai-product-quiz-image-placeholder-{{ ai_gen_id }}">
            {{ 'product-apparel-1' | placeholder_svg_tag }}
            <div class="ai-product-quiz-empty-state-{{ ai_gen_id }}">
              Add your product image
            </div>
          </div>
        {% endif %}

        <div
            class="ai-product-quiz-text-overlay-{{ ai_gen_id }}" style="display: none;"
            data-overlay-text
        ></div>
      </div>
    </div>

    <div class="ai-product-quiz-content-section-{{ ai_gen_id }}">
      {% if block.settings.subtitle != blank %}
        <div class="ai-product-quiz-subtitle-{{ ai_gen_id }}">
          {{ block.settings.subtitle }}
        </div>
      {% endif %}

      {% if block.settings.title != blank %}
        <h2 class="ai-product-quiz-title-{{ ai_gen_id }}">
          {{ block.settings.title }}
        </h2>
      {% endif %}

      <div class="ai-product-quiz-form-wrapper-{{ ai_gen_id }}">
        <input
            type="text"
            class="ai-product-quiz-input-{{ ai_gen_id }}"
            placeholder="{{ block.settings.input_placeholder }}"
            data-name-input
            autocomplete="given-name"
        >
        <button
            type="button"
            class="ai-product-quiz-submit-{{ ai_gen_id }}"
            data-submit-button
            data-submit-link="{{ block.settings.submit_link }}"
            aria-label="Submit"
        >
          <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
          >
            <path d="m9 18 6-6-6-6"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</product-quiz-{{ ai_gen_id }}>

<script>
    (function() {
        class ProductQuiz{{ ai_gen_id }} extends HTMLElement {
            constructor() {
                super();
            }

            connectedCallback() {
                this.nameInput = this.querySelector('[data-name-input]');
                this.textOverlay = this.querySelector('[data-overlay-text]');
                this.submitButton = this.querySelector('[data-submit-button]');

                this.setupEventListeners();
            }

            setupEventListeners() {
                if (this.nameInput && this.textOverlay) {
                    this.nameInput.addEventListener('input', (e) => {
                        this.updateOverlayText(e.target.value);
                    });

                    this.nameInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.handleSubmit();
                        }
                    });
                }

                if (this.submitButton) {
                    this.submitButton.addEventListener('click', () => {
                        this.handleSubmit();
                    });
                }
            }

            updateOverlayText(text) {
                if (this.textOverlay) {
                    this.textOverlay.textContent = text;
                }
            }

            handleSubmit() {
                const name = this.nameInput ? this.nameInput.value.trim() : '';

                if (!name) {
                    this.nameInput.focus();
                    return;
                }

                const baseUrl = this.submitButton.getAttribute('data-submit-link') || '/';
                const separator = baseUrl.includes('?') ? '&' : '?';
                const targetUrl = `${baseUrl}${separator}name=${encodeURIComponent(name)}`;

                window.location.href = targetUrl;
            }
        }

        customElements.define('product-quiz-{{ ai_gen_id }}', ProductQuiz{{ ai_gen_id }});
    })();
</script>

{% schema %}
{
  "name": "Custom Product Quiz",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width section",
      "default": true
    },
    {
      "type": "range",
      "id": "section_padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Section padding",
      "default": 60
    },
    {
      "type": "range",
      "id": "image_width",
      "min": 30,
      "max": 70,
      "step": 5,
      "unit": "%",
      "label": "Image section width",
      "default": 45
    },
    {
      "type": "range",
      "id": "content_gap",
      "min": 20,
      "max": 80,
      "step": 5,
      "unit": "px",
      "label": "Gap between sections",
      "default": 40
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Product image"
    },
    {
      "type": "image_picker",
      "id": "product_image",
      "label": "Product image"
    },
    {
      "type": "range",
      "id": "image_size",
      "min": 100,
      "max": 500,
      "step": 10,
      "unit": "px",
      "label": "Image size",
      "default": 300
    },
    {
      "type": "range",
      "id": "image_position_desktop_x",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Desktop horizontal position",
      "default": 50
    },
    {
      "type": "range",
      "id": "image_position_desktop_y",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Desktop vertical position",
      "default": 50
    },
    {
      "type": "range",
      "id": "image_position_mobile_x",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Mobile horizontal position",
      "default": 50
    },
    {
      "type": "range",
      "id": "image_position_mobile_y",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Mobile vertical position",
      "default": 50
    },
    {
      "type": "header",
      "content": "Text overlay on image"
    },
    {
      "type": "range",
      "id": "text_position_desktop_x",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Desktop horizontal position",
      "default": 50
    },
    {
      "type": "range",
      "id": "text_position_desktop_y",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Desktop vertical position",
      "default": 30
    },
    {
      "type": "range",
      "id": "text_position_mobile_x",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Mobile horizontal position",
      "default": 50
    },
    {
      "type": "range",
      "id": "text_position_mobile_y",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Mobile vertical position",
      "default": 25
    },
    {
      "type": "font_picker",
      "id": "overlay_font",
      "label": "Overlay font",
      "default": "serif"
    },
    {
      "type": "range",
      "id": "overlay_text_size",
      "min": 12,
      "max": 48,
      "step": 2,
      "unit": "px",
      "label": "Overlay text size",
      "default": 24
    },
    {
      "type": "color",
      "id": "overlay_text_color",
      "label": "Overlay text color",
      "default": "#232323"
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Personalized for you"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Find Your Perfect Match"
    },
    {
      "type": "range",
      "id": "subtitle_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Subtitle size",
      "default": 16
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 18,
      "max": 48,
      "step": 2,
      "unit": "px",
      "label": "Title size",
      "default": 32
    },
    {
      "type": "color",
      "id": "subtitle_color",
      "label": "Subtitle color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title color",
      "default": "#232323"
    },
    {
      "type": "header",
      "content": "Input field"
    },
    {
      "type": "text",
      "id": "input_placeholder",
      "label": "Input placeholder",
      "default": "Enter Your Name"
    },
    {
      "type": "range",
      "id": "input_text_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Input text size",
      "default": 16
    },
    {
      "type": "range",
      "id": "input_border_radius",
      "min": 0,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Input border radius",
      "default": 8
    },
    {
      "type": "color",
      "id": "input_background_color",
      "label": "Input background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "input_text_color",
      "label": "Input text color",
      "default": "#232323"
    },
    {
      "type": "color",
      "id": "input_border_color",
      "label": "Input border color",
      "default": "#cccccc"
    },
    {
      "type": "color",
      "id": "input_focus_border_color",
      "label": "Input focus border color",
      "default": "#007acc"
    },
    {
      "type": "color",
      "id": "input_placeholder_color",
      "label": "Placeholder text color",
      "default": "#999999"
    },
    {
      "type": "header",
      "content": "Submit button"
    },
    {
      "type": "url",
      "id": "submit_link",
      "label": "Submit link (destination URL)"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "label": "Button border radius",
      "default": 8
    },
    {
      "type": "color",
      "id": "button_background_color",
      "label": "Button background",
      "default": "#007acc"
    },
    {
      "type": "color",
      "id": "button_hover_background_color",
      "label": "Button hover background",
      "default": "#005a99"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button icon color",
      "default": "#ffffff"
    }
  ],
  "presets": [
    {
      "name": "Custom Product Quiz"
    }
  ]
}
{% endschema %}