{% comment %}
  Quiz Recommendations Section for Shopify
  Shows recommended products based on quiz answers with Seal Subscriptions support
{% endcomment %}

{{ 'quiz-section.css' | asset_url | stylesheet_tag }}

{%- style -%}
    .quiz-recommendations-{{ section.id }} {
    --primary-color: {{ section.settings.primary_color }};
    --text-color: {{ section.settings.text_color }};
    --highlight-color: {{ section.settings.highlight_color }};
    --button-color: {{ section.settings.button_color }};
    --button-text-color: {{ section.settings.button_text_color }};
    --btn-border-radius: {{ section.settings.button_border_radius }};
    --remove-button-color: {{ section.settings.remove_button_color }};
    --remove-button-text-color: {{ section.settings.remove_button_text_color }};
    --checkout-button-color: {{ section.settings.checkout_button_color }};
    --checkout-button-text-color: {{ section.settings.checkout_button_text_color }};
    --gift-progress-bar-color: {{ section.settings.gift_progress_bar_color | default: '#d4ff6a' }};
    --gift-progress-bar-bg-color: {{ section.settings.gift_progress_bar_bg_color | default: '#e5e7eb' }};
    --gift-milestone-color: {{ section.settings.gift_milestone_color | default: '#d4ff6a' }};
    }

    #shopify-section-{{ section.id }}.quiz-section {
    background: {{ section.settings.background_color }};
    }
{%- endstyle -%}

<div class="quiz-recommendations quiz-section quiz-recommendations-{{ section.id }}" data-recommendations style="display: none;" data-product-sort-order="{% if section.settings.product_sort_order != blank %}{{ section.settings.product_sort_order | map: 'handle' | join: ',' }}{% endif %}" data-bogo-enabled="{{ section.settings.bogo_enabled }}" data-bogo-products="{% if section.settings.bogo_products != blank %}{{ section.settings.bogo_products | map: 'handle' | join: ',' }}{% endif %}" data-bogo-badge-text="{{ section.settings.bogo_badge_text }}" data-bogo-cart-text="{{ section.settings.bogo_cart_text }}">
    <div class="recommendations-layout">
        <!-- Left Side: Gift Product & Recommended Products -->
        <div class="recommendations-left">
            {% if section.settings.gift_tiers_enabled %}
                {%- comment -%} Tiered Gift System {%- endcomment -%}
                <div class="gift-tiers-container"
                    data-gift-tiers-enabled="true"
                    data-tier1-threshold="{{ section.settings.tier1_threshold | default: 100 }}"
                    data-tier1-female="{{ section.settings.tier1_gift_female.handle | default: '' }}"
                    data-tier1-variant-female="{{ section.settings.tier1_variant_female | default: '' }}"
                    data-tier1-male="{{ section.settings.tier1_gift_male.handle | default: '' }}"
                    data-tier1-variant-male="{{ section.settings.tier1_variant_male | default: '' }}"
                    data-tier1-banner="{{ section.settings.tier1_banner_text | default: 'FREE GIFT UNLOCKED!' }}"
                    data-tier1-description="{{ section.settings.tier1_description | default: '' }}"
                    data-tier2-threshold="{{ section.settings.tier2_threshold | default: 0 }}"
                    data-tier2-female="{{ section.settings.tier2_gift_female.handle | default: '' }}"
                    data-tier2-variant-female="{{ section.settings.tier2_variant_female | default: '' }}"
                    data-tier2-male="{{ section.settings.tier2_gift_male.handle | default: '' }}"
                    data-tier2-variant-male="{{ section.settings.tier2_variant_male | default: '' }}"
                    data-tier2-banner="{{ section.settings.tier2_banner_text | default: 'BONUS GIFT UNLOCKED!' }}"
                    data-tier2-description="{{ section.settings.tier2_description | default: '' }}"
                    data-tier3-threshold="{{ section.settings.tier3_threshold | default: 0 }}"
                    data-tier3-female="{{ section.settings.tier3_gift_female.handle | default: '' }}"
                    data-tier3-variant-female="{{ section.settings.tier3_variant_female | default: '' }}"
                    data-tier3-male="{{ section.settings.tier3_gift_male.handle | default: '' }}"
                    data-tier3-variant-male="{{ section.settings.tier3_variant_male | default: '' }}"
                    data-tier3-banner="{{ section.settings.tier3_banner_text | default: 'VIP GIFT UNLOCKED!' }}"
                    data-tier3-description="{{ section.settings.tier3_description | default: '' }}"
                    data-progress-text="{{ section.settings.gift_progress_text | default: 'Add [[remaining]] more to unlock your next gift!' }}"
                    data-complete-text="{{ section.settings.gift_complete_text | default: 'You have unlocked all free gifts!' }}"
                >
                    {%- comment -%} Progress Bar Section {%- endcomment -%}
                    <div class="gift-progress-section" data-gift-progress-section>
                        <div class="gift-progress-header">
                            <span class="gift-progress-label" data-gift-progress-label>{{ section.settings.gift_progress_text | default: 'Add items to unlock gifts!' }}</span>
                            <button class="gift-toggle-btn" data-gift-toggle aria-label="Toggle gifts" aria-expanded="false">
                                <svg class="gift-toggle-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                    <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                        <div class="gift-progress-bar-container">
                            <div class="gift-progress-bar" data-gift-progress-bar style="width: 0%"></div>
                            <div class="gift-progress-milestones" data-gift-milestones>
                                {%- comment -%} Milestones will be dynamically added by JS {%- endcomment -%}
                            </div>
                        </div>
                    </div>

                    {%- comment -%} Gift Cards Container - gifts will be added dynamically {%- endcomment -%}
                    <div class="gift-cards-container" data-gift-cards-container>
                        {%- comment -%} Gift cards are inserted here by JavaScript {%- endcomment -%}
                    </div>
                </div>
            {% elsif section.settings.gift_product != blank %}
                {%- comment -%} Legacy single gift product {%- endcomment -%}
                <div class="gift-product-card" data-gift-product="{{ section.settings.gift_product.handle }}">
                    <div class="gift-card-body">
                        {% if section.settings.gift_banner_text != blank %}
                            <div class="gift-banner-top">{{ section.settings.gift_banner_text }}</div>
                        {% endif %}
                        <div class="gift-card-main">
                            <div class="gift-card-image">
                                {% if section.settings.gift_product.featured_image %}
                                    <img src="{{ section.settings.gift_product.featured_image | image_url: width: 600 }}" alt="{{ section.settings.gift_product.title }}">
                                {% endif %}
                                <h3 class="gift-product-title gift-product-title-mobile">{{ section.settings.gift_product.title }}</h3>
                            </div>
                            <div class="gift-card-content">
                                <h3 class="gift-product-title gift-product-title-desktop">
                                    {{ section.settings.gift_product.title }}
                                </h3>
                                {% if section.settings.gift_description != blank %}
                                    <p class="gift-product-description">{{ section.settings.gift_description }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            {% if section.settings.title != blank %}
                <h2 class="recommendations-title">{{ section.settings.title }}</h2>
            {% endif %}

            {% if section.settings.subtitle != blank %}
                <div class="recommendations-subtitle">{{ section.settings.subtitle }}</div>
            {% endif %}

            <div class="recommended-products-list" data-recommended-list>
                <!-- Section 1: Top 3 Picks (Auto-added to cart) -->
                <div class="recommendations-section" data-section="top-picks">
                    {% if section.settings.section1_title != blank %}
                        <h3 class="section-title">{{ section.settings.section1_title }}</h3>
                    {% endif %}
                    {% if section.settings.section1_description != blank %}
                        <div class="section-description">{{ section.settings.section1_description }}</div>
                    {% endif %}
                    <div class="section-products" data-section-products="top-picks"></div>
                </div>

                <hr class="section-divider">

                <!-- Section 2: Additional Recommendations (Not auto-added) -->
                <div class="recommendations-section" data-section="additional">
                    {% if section.settings.section2_title != blank %}
                        <h3 class="section-title">{{ section.settings.section2_title }}</h3>
                    {% endif %}
                    {% if section.settings.section2_description != blank %}
                        <div class="section-description">{{ section.settings.section2_description }}</div>
                    {% endif %}
                    <div class="section-products" data-section-products="additional"></div>
                </div>

                <hr class="section-divider">

                <!-- Section 3: Accessories (Manual products, not auto-added) -->
                <div class="recommendations-section" data-section="accessories">
                    {% if section.settings.section3_title != blank %}
                        <h3 class="section-title">{{ section.settings.section3_title }}</h3>
                    {% endif %}
                    {% if section.settings.section3_description != blank %}
                        <div class="section-description">{{ section.settings.section3_description }}</div>
                    {% endif %}
                    <div class="section-products" data-section-products="accessories"></div>
                </div>
            </div>
        </div>

        <!-- Right Side: Cart Summary -->
        <div class="recommendations-right">
            <div class="cart-summary">
                <div class="cart-summary-header" data-cart-header>
                    <div class="cart-header-content">
                        <div class="cart-header-left">
                            <h3 class="cart-summary-title">Order Summary</h3>
                            <span class="cart-item-count" data-item-count>(0)</span>
                        </div>
                        <button class="cart-toggle-btn" data-cart-toggle aria-label="Toggle cart">
                            <svg class="cart-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="cart-header-total">
                        <span class="total-price-header" data-total-price-header>$0.00</span>
                    </div>
                </div>
                <button class="quiz-btn quiz-btn-checkout checkout-mobile" data-checkout-btn>
                    Checkout
                </button>
                {% if section.settings.checkout_subtext != blank %}
                    <div class="checkout-subtext checkout-mobile">{{ section.settings.checkout_subtext }}</div>
                {% endif %}
                <button class="cart-close-btn" data-cart-close aria-label="Close cart">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="cart-summary-body" data-cart-body>
                    <div class="cart-items" data-cart-items>
                        <!-- Cart items will be added here dynamically -->
                    </div>
                    <span class="total-price" data-total-price style="display: none;">$0.00</span>
                    <button class="quiz-btn quiz-btn-checkout" data-checkout-btn>
                        Checkout
                    </button>
                    {% if section.settings.checkout_subtext != blank %}
                        <div class="checkout-subtext">{{ section.settings.checkout_subtext }}</div>
                    {% endif %}
                    {% if section.settings.highlight_text_desktop != blank %}
                        <div class="cart-highlight-box-external desktop-only cart-highlight-fullscreen" data-highlight-text>
                            {{ section.settings.highlight_text_desktop }}
                        </div>
                    {% endif %}
                </div>
            </div>

            {% if section.settings.highlight_text_desktop != blank %}
                <div class="cart-highlight-box-external desktop-only cart-highlight-static" data-highlight-text>
                    {{ section.settings.highlight_text_desktop }}
                </div>
            {% endif %}
            {% if section.settings.highlight_text_mobile != blank %}
                <div class="cart-highlight-box-external mobile-only" data-highlight-text>
                    {{ section.settings.highlight_text_mobile }}
                </div>
            {% endif %}
        </div>
    </div>
</div>

{{ 'quiz-recommendations.css.liquid' | asset_url }}

{{ 'quiz-recommendations.js' | asset_url }}

<script>
(function() {
    // Pass Liquid variables to external script
    window.quizRecommendationsConfig = {
        accessoryHandles: {{ section.settings.accessories_products | json }}
    };
    
    // External script will handle initialization
})();
</script>

{% schema %}
{
    "name": "Quiz Recommendations",
    "class": "quiz-section",
    "settings": [
        {
            "type": "text",
            "id": "title",
            "label": "Title",
            "default": "Your Personalized Recommendations"
        },
        {
            "type": "richtext",
            "id": "subtitle",
            "label": "Subtitle"
        },
        {
            "type": "header",
            "content": "Product Order"
        },
        {
            "type": "product_list",
            "id": "product_sort_order",
            "label": "Custom Product Order (Optional)",
            "info": "Set the display order of recommended products. Only products that were recommended by the quiz will be shown, in the order specified here. Leave empty to use default quiz order.",
            "limit": 20
        },
        {
            "type": "header",
            "content": "Section 1: Top Picks"
        },
        {
            "type": "text",
            "id": "section1_title",
            "label": "Section 1 Title",
            "default": "Our Top 3 Picks For You"
        },
        {
            "type": "richtext",
            "id": "section1_description",
            "label": "Section 1 Description",
            "info": "First 3 quiz recommendations, auto-added to cart"
        },
        {
            "type": "header",
            "content": "Section 2: Additional Recommendations"
        },
        {
            "type": "text",
            "id": "section2_title",
            "label": "Section 2 Title",
            "default": "Transform your routine into a ritual"
        },
        {
            "type": "richtext",
            "id": "section2_description",
            "label": "Section 2 Description",
            "info": "Remaining quiz recommendations, not auto-added to cart"
        },
        {
            "type": "header",
            "content": "Section 3: Accessories"
        },
        {
            "type": "text",
            "id": "section3_title",
            "label": "Section 3 Title",
            "default": "Hair Accessories You didn't know Your Hair Needed"
        },
        {
            "type": "richtext",
            "id": "section3_description",
            "label": "Section 3 Description",
            "info": "Manual product selection, not auto-added to cart"
        },
        {
            "type": "product_list",
            "id": "accessories_products",
            "label": "Accessory Products",
            "info": "Select products to display in the accessories section"
        },
        {
            "type": "header",
            "content": "Tiered Gift System"
        },
        {
            "type": "checkbox",
            "id": "gift_tiers_enabled",
            "label": "Enable Tiered Gifts",
            "default": false,
            "info": "Enable to show tiered free gifts based on cart total"
        },
        {
            "type": "text",
            "id": "gift_progress_text",
            "label": "Progress Bar Text",
            "default": "Spend [[remaining]] more to unlock your next gift!",
            "info": "Use [[remaining]] for amount needed, [[current]] for current total, [[next_tier]] for next tier threshold"
        },
        {
            "type": "text",
            "id": "gift_complete_text",
            "label": "All Tiers Complete Text",
            "default": "You've unlocked all free gifts!",
            "info": "Shown when all gift tiers have been reached"
        },
        {
            "type": "color",
            "id": "gift_progress_bar_color",
            "label": "Progress Bar Color",
            "default": "#d4ff6a"
        },
        {
            "type": "color",
            "id": "gift_progress_bar_bg_color",
            "label": "Progress Bar Background Color",
            "default": "#e5e7eb"
        },
        {
            "type": "color",
            "id": "gift_milestone_color",
            "label": "Milestone Reached Color",
            "default": "#d4ff6a"
        },
        {
            "type": "header",
            "content": "Tier 1 Gift"
        },
        {
            "type": "number",
            "id": "tier1_threshold",
            "label": "Tier 1 - Minimum Cart Total",
            "default": 100,
            "info": "Cart total (in base currency, e.g. EUR) needed to unlock Tier 1 gift"
        },
        {
            "type": "product",
            "id": "tier1_gift_female",
            "label": "Tier 1 - Gift Product (Female)"
        },
        {
            "type": "text",
            "id": "tier1_variant_female",
            "label": "Tier 1 - Variant ID (Female)",
            "info": "Optional: Enter the variant ID to use a specific variant. Leave empty for default variant."
        },
        {
            "type": "product",
            "id": "tier1_gift_male",
            "label": "Tier 1 - Gift Product (Male)"
        },
        {
            "type": "text",
            "id": "tier1_variant_male",
            "label": "Tier 1 - Variant ID (Male)",
            "info": "Optional: Enter the variant ID to use a specific variant. Leave empty for default variant."
        },
        {
            "type": "text",
            "id": "tier1_banner_text",
            "label": "Tier 1 - Banner Text",
            "default": "FREE GIFT UNLOCKED!"
        },
        {
            "type": "textarea",
            "id": "tier1_description",
            "label": "Tier 1 - Gift Description",
            "default": "Complimentary with your purchase"
        },
        {
            "type": "header",
            "content": "Tier 2 Gift"
        },
        {
            "type": "number",
            "id": "tier2_threshold",
            "label": "Tier 2 - Minimum Cart Total",
            "default": 150,
            "info": "Cart total (in base currency, e.g. EUR) needed to unlock Tier 2 gift (set to 0 to disable)"
        },
        {
            "type": "product",
            "id": "tier2_gift_female",
            "label": "Tier 2 - Gift Product (Female)"
        },
        {
            "type": "text",
            "id": "tier2_variant_female",
            "label": "Tier 2 - Variant ID (Female)",
            "info": "Optional: Enter the variant ID to use a specific variant. Leave empty for default variant."
        },
        {
            "type": "product",
            "id": "tier2_gift_male",
            "label": "Tier 2 - Gift Product (Male)"
        },
        {
            "type": "text",
            "id": "tier2_variant_male",
            "label": "Tier 2 - Variant ID (Male)",
            "info": "Optional: Enter the variant ID to use a specific variant. Leave empty for default variant."
        },
        {
            "type": "text",
            "id": "tier2_banner_text",
            "label": "Tier 2 - Banner Text",
            "default": "BONUS GIFT UNLOCKED!"
        },
        {
            "type": "textarea",
            "id": "tier2_description",
            "label": "Tier 2 - Gift Description",
            "default": "Extra reward for your order"
        },
        {
            "type": "header",
            "content": "Tier 3 Gift"
        },
        {
            "type": "number",
            "id": "tier3_threshold",
            "label": "Tier 3 - Minimum Cart Total",
            "default": 200,
            "info": "Cart total (in base currency, e.g. EUR) needed to unlock Tier 3 gift (set to 0 to disable)"
        },
        {
            "type": "product",
            "id": "tier3_gift_female",
            "label": "Tier 3 - Gift Product (Female)"
        },
        {
            "type": "text",
            "id": "tier3_variant_female",
            "label": "Tier 3 - Variant ID (Female)",
            "info": "Optional: Enter the variant ID to use a specific variant. Leave empty for default variant."
        },
        {
            "type": "product",
            "id": "tier3_gift_male",
            "label": "Tier 3 - Gift Product (Male)"
        },
        {
            "type": "text",
            "id": "tier3_variant_male",
            "label": "Tier 3 - Variant ID (Male)",
            "info": "Optional: Enter the variant ID to use a specific variant. Leave empty for default variant."
        },
        {
            "type": "text",
            "id": "tier3_banner_text",
            "label": "Tier 3 - Banner Text",
            "default": "VIP GIFT UNLOCKED!"
        },
        {
            "type": "textarea",
            "id": "tier3_description",
            "label": "Tier 3 - Gift Description",
            "default": "Thank you for your loyalty"
        },
        {
            "type": "header",
            "content": "Legacy Gift Product (deprecated)"
        },
        {
            "type": "product",
            "id": "gift_product",
            "label": "Gift Product (optional)",
            "info": "Deprecated - use Tiered Gift System above instead"
        },
        {
            "type": "text",
            "id": "gift_banner_text",
            "label": "Gift Banner Text",
            "default": "FREE GIFT ADDED TO YOUR CART",
            "info": "Text shown in the top bar of the gift product card"
        },
        {
            "type": "textarea",
            "id": "gift_description",
            "label": "Gift Description",
            "default": "Complimentary with your purchase"
        },
        {
            "type": "header",
            "content": "Black Friday BOGO Promo"
        },
        {
            "type": "checkbox",
            "id": "bogo_enabled",
            "label": "Enable BOGO Promo",
            "default": false,
            "info": "Turn on/off the Buy One Get One Free promotion"
        },
        {
            "type": "product_list",
            "id": "bogo_products",
            "label": "BOGO Eligible Products",
            "info": "Select products that are eligible for Buy One Get One Free (one-time purchases only, not subscriptions)",
            "limit": 20
        },
        {
            "type": "text",
            "id": "bogo_badge_text",
            "label": "BOGO Badge Text",
            "default": "BUY 1 GET 1 FREE",
            "info": "Text shown on product card badges"
        },
        {
            "type": "text",
            "id": "bogo_cart_text",
            "label": "BOGO Cart Text",
            "default": "Buy 1 Get 1 Free",
            "info": "Text shown in cart for BOGO items"
        },
        {
            "type": "header",
            "content": "Colors"
        },
        {
            "type": "color",
            "id": "primary_color",
            "label": "Primary Color",
            "default": "#000000"
        },
        {
            "type": "color",
            "id": "text_color",
            "label": "Text Color",
            "default": "#111827"
        },
        {
            "type": "color",
            "id": "highlight_color",
            "label": "Highlight Color",
            "default": "#d4ff6a",
            "info": "Used for gift banner and highlight boxes"
        },
        {
            "type": "color",
            "id": "button_color",
            "label": "Button Background Color",
            "default": "#000000"
        },
        {
            "type": "color",
            "id": "button_text_color",
            "label": "Button Text Color",
            "default": "#ffffff"
        },
        {
            "type": "text",
            "id": "button_border_radius",
            "label": "Button Border Radius",
            "default": "5rem",
            "info": "CSS value for button border radius (e.g., 5rem, 8px, 50%)"
        },
        {
            "type": "color",
            "id": "remove_button_color",
            "label": "Remove Button Background Color",
            "default": "#ef4444"
        },
        {
            "type": "color",
            "id": "remove_button_text_color",
            "label": "Remove Button Text Color",
            "default": "#ffffff"
        },
        {
            "type": "color",
            "id": "checkout_button_color",
            "label": "Checkout Button Background Color",
            "default": "#22c55e",
            "info": "Background color for the checkout button"
        },
        {
            "type": "color",
            "id": "checkout_button_text_color",
            "label": "Checkout Button Text Color",
            "default": "#ffffff",
            "info": "Text color for the checkout button"
        },
        {
            "type": "color",
            "id": "background_color",
            "label": "Background Color",
            "default": "#f0f0ff"
        },
        {
            "type": "header",
            "content": "Highlight Text Boxes"
        },
        {
            "type": "richtext",
            "id": "highlight_text_desktop",
            "label": "Highlight Text (Desktop)",
            "info": "Appears in cart summary on desktop. Use [[amount:100]] for auto-converted currency (e.g., '[[amount:100]]' becomes '$180' in USD)",
            "default": "<p><strong>60% off</strong> + free shipping applied!</p>"
        },
        {
            "type": "richtext",
            "id": "highlight_text_mobile",
            "label": "Highlight Text (Mobile)",
            "info": "Appears in cart summary on mobile. Use [[amount:100]] for auto-converted currency (e.g., '[[amount:100]]' becomes '$180' in USD)",
            "default": "<p><strong>60% off</strong> + free shipping applied!</p>"
        },
        {
            "type": "text",
            "id": "checkout_subtext",
            "label": "Checkout Subtext",
            "info": "Text displayed under the main checkout button.",
            "default": "if you donâ€™t like your first order it will be on us"
        }
    ],
    "presets": [
        {
            "name": "Quiz Recommendations"
        }
    ]
}
{% endschema %}