{% comment %}
  Quiz Recommendations Section for Shopify
  Shows recommended products based on quiz answers with Seal Subscriptions support
{% endcomment %}

{{ 'quiz-section.css' | asset_url | stylesheet_tag }}

{%- style -%}
    .quiz-recommendations-{{ section.id }} {
    --primary-color: {{ section.settings.primary_color }};
    --text-color: {{ section.settings.text_color }};
    --highlight-color: {{ section.settings.highlight_color }};
    --button-color: {{ section.settings.button_color }};
    --button-text-color: {{ section.settings.button_text_color }};
    --btn-border-radius: {{ section.settings.button_border_radius }};
    --remove-button-color: {{ section.settings.remove_button_color }};
    --remove-button-text-color: {{ section.settings.remove_button_text_color }};
    --checkout-button-color: {{ section.settings.checkout_button_color }};
    --checkout-button-text-color: {{ section.settings.checkout_button_text_color }};
    --gift-progress-bar-color: {{ section.settings.gift_progress_bar_color | default: '#d4ff6a' }};
    --gift-progress-bar-bg-color: {{ section.settings.gift_progress_bar_bg_color | default: '#e5e7eb' }};
    --gift-milestone-color: {{ section.settings.gift_milestone_color | default: '#d4ff6a' }};
    }

    #shopify-section-{{ section.id }}.quiz-section {
    background: {{ section.settings.background_color }};
    }
{%- endstyle -%}

<div class="quiz-recommendations quiz-section quiz-recommendations-{{ section.id }}" data-recommendations style="display: none;" data-product-sort-order="{% if section.settings.product_sort_order != blank %}{{ section.settings.product_sort_order | map: 'handle' | join: ',' }}{% endif %}" data-bogo-enabled="{{ section.settings.bogo_enabled }}" data-bogo-products="{% if section.settings.bogo_products != blank %}{{ section.settings.bogo_products | map: 'handle' | join: ',' }}{% endif %}" data-bogo-badge-text="{{ section.settings.bogo_badge_text }}" data-bogo-cart-text="{{ section.settings.bogo_cart_text }}" data-countdown-hours="{{ section.settings.countdown_hours | default: 0 }}" data-countdown-minutes="{{ section.settings.countdown_minutes | default: 9 }}" data-countdown-seconds="{{ section.settings.countdown_seconds | default: 57 }}">
    <div class="quiz-recommendations-wrapper">
        <!-- Content Layout (Products + Right Column) -->
        <div class="quiz-recommendations-content-layout">
            <!-- Left Column: Products Content -->
            <div class="quiz-recommendations-content-column">
                <!-- Header Section -->
                <div class="quiz-recommendations-header">
                    <!-- Feature Bar -->
                    {% if section.settings.show_feature_bar %}
                        <div class="recommendations-feature-bar">
                            {% for block in section.blocks %}
                                {% if block.type == 'feature_item' %}
                                    <div class="feature-item" {{ block.shopify_attributes }}>
                                        {% if block.settings.feature_icon != blank %}
                                            <img src="{{ block.settings.feature_icon | image_url: width: 24 }}" alt="{{ block.settings.feature_text }}" class="feature-icon">
                                        {% endif %}
                                        <span class="feature-text">{{ block.settings.feature_text }}</span>
                                        <svg class="feature-checkmark" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                            <path d="M13.3333 4L6 11.3333L2.66667 8" stroke="#1a365d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Sale Banner -->
                    {% if section.settings.sale_banner_text != blank %}
                        <h1 class="recommendations-sale-banner">{{ section.settings.sale_banner_text }}</h1>
                    {% endif %}

                    <!-- Intro Text -->
                    {% if section.settings.intro_text != blank %}
                        <div class="recommendations-intro-text">{{ section.settings.intro_text }}</div>
                    {% endif %}

                    <!-- CTA Button -->
                    {% if section.settings.cta_button_text != blank %}
                        <button class="recommendations-cta-button" data-recommendations-cta>
                            {{ section.settings.cta_button_text }}
                        </button>
                    {% endif %}
                </div>
                {% if section.settings.gift_tiers_enabled %}
                    {%- comment -%} Tiered Gift System {%- endcomment -%}
                    <div class="gift-tiers-container"
                        data-gift-tiers-enabled="true"
                        data-tier1-threshold="{{ section.settings.tier1_threshold | default: 100 }}"
                        data-tier1-female="{{ section.settings.tier1_gift_female.handle | default: '' }}"
                        data-tier1-variant-female="{{ section.settings.tier1_variant_female | default: '' }}"
                        data-tier1-male="{{ section.settings.tier1_gift_male.handle | default: '' }}"
                        data-tier1-variant-male="{{ section.settings.tier1_variant_male | default: '' }}"
                        data-tier1-banner="{{ section.settings.tier1_banner_text | default: 'FREE GIFT UNLOCKED!' }}"
                        data-tier1-description="{{ section.settings.tier1_description | default: '' }}"
                        data-tier2-threshold="{{ section.settings.tier2_threshold | default: 0 }}"
                        data-tier2-female="{{ section.settings.tier2_gift_female.handle | default: '' }}"
                        data-tier2-variant-female="{{ section.settings.tier2_variant_female | default: '' }}"
                        data-tier2-male="{{ section.settings.tier2_gift_male.handle | default: '' }}"
                        data-tier2-variant-male="{{ section.settings.tier2_variant_male | default: '' }}"
                        data-tier2-banner="{{ section.settings.tier2_banner_text | default: 'BONUS GIFT UNLOCKED!' }}"
                        data-tier2-description="{{ section.settings.tier2_description | default: '' }}"
                        data-tier3-threshold="{{ section.settings.tier3_threshold | default: 0 }}"
                        data-tier3-female="{{ section.settings.tier3_gift_female.handle | default: '' }}"
                        data-tier3-variant-female="{{ section.settings.tier3_variant_female | default: '' }}"
                        data-tier3-male="{{ section.settings.tier3_gift_male.handle | default: '' }}"
                        data-tier3-variant-male="{{ section.settings.tier3_variant_male | default: '' }}"
                        data-tier3-banner="{{ section.settings.tier3_banner_text | default: 'VIP GIFT UNLOCKED!' }}"
                        data-tier3-description="{{ section.settings.tier3_description | default: '' }}"
                        data-progress-text="{{ section.settings.gift_progress_text | default: 'Add [[remaining]] more to unlock your next gift!' }}"
                        data-complete-text="{{ section.settings.gift_complete_text | default: 'You have unlocked all free gifts!' }}"
                    >
                        {%- comment -%} Progress Bar Section {%- endcomment -%}
                        <div class="gift-progress-section" data-gift-progress-section>
                            <div class="gift-progress-header">
                                <span class="gift-progress-label" data-gift-progress-label>{{ section.settings.gift_progress_text | default: 'Add items to unlock gifts!' }}</span>
                                <button class="gift-toggle-btn" data-gift-toggle aria-label="Toggle gifts" aria-expanded="false">
                                    <svg class="gift-toggle-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                        <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="gift-progress-bar-container">
                                <div class="gift-progress-bar" data-gift-progress-bar style="width: 0%"></div>
                                <div class="gift-progress-milestones" data-gift-milestones>
                                    {%- comment -%} Milestones will be dynamically added by JS {%- endcomment -%}
                                </div>
                            </div>
                        </div>

                        {%- comment -%} Gift Cards Container - gifts will be added dynamically {%- endcomment -%}
                        <div class="gift-cards-container" data-gift-cards-container>
                            {%- comment -%} Gift cards are inserted here by JavaScript {%- endcomment -%}
                        </div>
                    </div>
                {% elsif section.settings.gift_product != blank %}
                    {%- comment -%} Legacy single gift product {%- endcomment -%}
                    <div class="gift-product-card" data-gift-product="{{ section.settings.gift_product.handle }}">
                        <div class="gift-card-body">
                            {% if section.settings.gift_banner_text != blank %}
                                <div class="gift-banner-top">{{ section.settings.gift_banner_text }}</div>
                            {% endif %}
                            <div class="gift-card-main">
                                <div class="gift-card-image">
                                    {% if section.settings.gift_product.featured_image %}
                                        <img src="{{ section.settings.gift_product.featured_image | image_url: width: 600 }}" alt="{{ section.settings.gift_product.title }}">
                                    {% endif %}
                                    <h3 class="gift-product-title gift-product-title-mobile">{{ section.settings.gift_product.title }}</h3>
                                </div>
                                <div class="gift-card-content">
                                    <h3 class="gift-product-title gift-product-title-desktop">
                                        {{ section.settings.gift_product.title }}
                                    </h3>
                                    {% if section.settings.gift_description != blank %}
                                        <p class="gift-product-description">{{ section.settings.gift_description }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if section.settings.title != blank %}
                    <h2 class="recommendations-title">{{ section.settings.title }}</h2>
                {% endif %}

                {% if section.settings.subtitle != blank %}
                    <div class="recommendations-subtitle">{{ section.settings.subtitle }}</div>
                {% endif %}

                <div class="recommended-products-list" data-recommended-list>
                    <!-- Section 1: Top 3 Picks (Auto-added to cart) -->
                    <div class="recommendations-section" data-section="top-picks">
                        {% if section.settings.section1_title != blank %}
                            <h3 class="section-title">{{ section.settings.section1_title }}</h3>
                        {% endif %}
                        {% if section.settings.section1_description != blank %}
                            <div class="section-description">{{ section.settings.section1_description }}</div>
                        {% endif %}
                        <div class="section-products" data-section-products="top-picks"></div>
                    </div>

                    <hr class="section-divider">

                    <!-- Section 2: Additional Recommendations (Not auto-added) -->
                    <div class="recommendations-section" data-section="additional">
                        {% if section.settings.section2_title != blank %}
                            <h3 class="section-title">{{ section.settings.section2_title }}</h3>
                        {% endif %}
                        {% if section.settings.section2_description != blank %}
                            <div class="section-description">{{ section.settings.section2_description }}</div>
                        {% endif %}
                        <div class="section-products" data-section-products="additional"></div>
                    </div>

                    <hr class="section-divider">

                    <!-- Section 3: Accessories (Manual products, not auto-added) -->
                    <div class="recommendations-section" data-section="accessories">
                        {% if section.settings.section3_title != blank %}
                            <h3 class="section-title">{{ section.settings.section3_title }}</h3>
                        {% endif %}
                        {% if section.settings.section3_description != blank %}
                            <div class="section-description">{{ section.settings.section3_description }}</div>
                        {% endif %}
                        <div class="section-products" data-section-products="accessories"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Upsell & Cart Summary (Desktop) -->
        <div class="quiz-recommendations-cart-column">
            <!-- Limited-Time Deal Banner -->
            {% if section.settings.show_limited_deal %}
                <div class="limited-deal-banner">
                    <div class="limited-deal-content">
                        <svg class="limited-deal-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M10 2L12.5 7.5L18 8.5L14 12.5L15 18L10 15L5 18L6 12.5L2 8.5L7.5 7.5L10 2Z" fill="currentColor"/>
                        </svg>
                        <span class="limited-deal-text">{{ section.settings.limited_deal_text | default: 'LIMITED-TIME CRAZY DEAL' }}</span>
                    </div>
                    <div class="limited-deal-timer" data-countdown-timer>
                        <span class="timer-value" data-timer-hours>00</span>:<span class="timer-value" data-timer-minutes>00</span>:<span class="timer-value" data-timer-seconds>00</span>:<span class="timer-value" data-timer-milliseconds>00</span>
                    </div>
                </div>
            {% endif %}

            <!-- Ultimate Hair Care Package Upsell -->
            {% if section.settings.upsell_product != blank %}
                <div class="upsell-package-card">
                    {% if section.settings.upsell_discount_percent > 0 %}
                        <div class="upsell-discount-badge">SAVE {{ section.settings.upsell_discount_percent }}%</div>
                    {% endif %}
                    {% if section.settings.upsell_image != blank %}
                        <div class="upsell-image">
                            <img src="{{ section.settings.upsell_image | image_url: width: 600 }}" alt="{{ section.settings.upsell_title }}">
                        </div>
                    {% endif %}
                    <div class="upsell-content">
                        <h3 class="upsell-title">{{ section.settings.upsell_title | default: 'Ultimate Hair Care Package' }}</h3>
                        {% if section.settings.upsell_description != blank %}
                            <div class="upsell-description">{{ section.settings.upsell_description }}</div>
                        {% endif %}
                        <button class="upsell-button" data-upsell-button data-product-handle="{{ section.settings.upsell_product.handle }}">
                            {{ section.settings.upsell_button_text | default: 'Claim Ultimate Package' }} — <span data-upsell-price>{{ section.settings.upsell_product.selected_or_first_available_variant.price | money }}</span>
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M7.5 5L12.5 10L7.5 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        {% if section.settings.upsell_fine_print != blank %}
                            <div class="upsell-fine-print">{{ section.settings.upsell_fine_print }}</div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Cart Summary -->
            <div class="cart-summary">
                <div class="cart-summary-header" data-cart-header>
                    <div class="cart-header-content">
                        <div class="cart-header-left">
                            <h3 class="cart-summary-title">Order Summary</h3>
                            <span class="cart-item-count" data-item-count>(0)</span>
                        </div>
                        <button class="cart-toggle-btn" data-cart-toggle aria-label="Toggle cart">
                            <svg class="cart-arrow" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="cart-header-total">
                        <span class="total-price-header" data-total-price-header>$0.00</span>
                    </div>
                </div>
                <button class="quiz-btn quiz-btn-checkout checkout-mobile" data-checkout-btn>
                    Checkout
                </button>
                {% if section.settings.checkout_subtext != blank %}
                    <div class="checkout-subtext checkout-mobile">{{ section.settings.checkout_subtext }}</div>
                {% endif %}
                <button class="cart-close-btn" data-cart-close aria-label="Close cart">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="cart-summary-body" data-cart-body>
                    <div class="cart-items" data-cart-items>
                        <!-- Cart items will be added here dynamically -->
                    </div>
                    <span class="total-price" data-total-price style="display: none;">$0.00</span>
                    <button class="quiz-btn quiz-btn-checkout" data-checkout-btn>
                        Checkout
                    </button>
                    {% if section.settings.checkout_subtext != blank %}
                        <div class="checkout-subtext">{{ section.settings.checkout_subtext }}</div>
                    {% endif %}
                    {% if section.settings.highlight_text_desktop != blank %}
                        <div class="cart-highlight-box-external desktop-only cart-highlight-fullscreen" data-highlight-text>
                            {{ section.settings.highlight_text_desktop }}
                        </div>
                    {% endif %}
                </div>
            </div>

            {% if section.settings.highlight_text_desktop != blank %}
                <div class="cart-highlight-box-external desktop-only cart-highlight-static" data-highlight-text>
                    {{ section.settings.highlight_text_desktop }}
                </div>
            {% endif %}
            {% if section.settings.highlight_text_mobile != blank %}
                <div class="cart-highlight-box-external mobile-only" data-highlight-text>
                    {{ section.settings.highlight_text_mobile }}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Mobile Sticky Cart Bar -->
    <div class="quiz-recommendations-mobile-sticky-bar">
        <div class="mobile-sticky-bar-content">
            <div class="mobile-sticky-bar-price-section">
                <div class="mobile-sticky-bar-price-label">
                    <span>Total Price (with savings)</span>
                    <button class="mobile-sticky-bar-dropdown-toggle" data-mobile-price-toggle aria-label="Toggle price details">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                <div class="mobile-sticky-bar-price-values">
                    <span class="mobile-sticky-bar-original-price" data-mobile-original-price>$144.60</span>
                    <span class="mobile-sticky-bar-total" data-mobile-total-price>$75.00</span>
                </div>
            </div>
            <button class="mobile-sticky-bar-checkout" data-mobile-checkout-btn>
                Checkout
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M3.33331 10H16.6666M16.6666 10L11.6666 5M16.6666 10L11.6666 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M3.33331 3.33331L3.33331 16.6666" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            {% if section.settings.checkout_subtext != blank %}
                <div class="mobile-sticky-bar-subtext">{{ section.settings.checkout_subtext }}</div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* Base Styles */
    #shopify-section-{{ section.id }} {
        padding: 0;
        display: block !important;
    }

    #shopify-section-{{ section.id }} .quiz-recommendations {
        min-height: fit-content;
        height: auto;
        display: block;
        background: #f7f7fc;
    }

    #shopify-section-{{ section.id }} .quiz-recommendations[style*="display: none"] {
        display: none !important;
    }

    #shopify-section-{{ section.id }} .quiz-recommendations.active {
        opacity: 1 !important;
        transform: translateY(0) !important;
    }

    /* Wrapper */
    #shopify-section-{{ section.id }} .quiz-recommendations-wrapper {
        display: flex;
        flex-direction: column;
        min-height: calc(100vh - 136px);
        background: #f7f7fc;
        width: 100%;
    }

    /* Header Section */
    #shopify-section-{{ section.id }} .quiz-recommendations-header {
        width: 100%;
        padding: 40px 60px 0;
        background: #f7f7fc;
    }

    /* Feature Bar */
    #shopify-section-{{ section.id }} .recommendations-feature-bar {
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    #shopify-section-{{ section.id }} .feature-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #shopify-section-{{ section.id }} .feature-icon {
        width: 24px;
        height: 24px;
        object-fit: contain;
    }

    #shopify-section-{{ section.id }} .feature-text {
        font-family: 'Gotham', sans-serif;
        font-size: 14px;
        font-weight: 400;
        color: #102B26;
    }

    #shopify-section-{{ section.id }} .feature-checkmark {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
    }

    /* Sale Banner */
    #shopify-section-{{ section.id }} .recommendations-sale-banner {
        font-family: 'Vanilla Ravioli', sans-serif;
        font-size: 48px;
        font-weight: 400;
        line-height: 1.2;
        color: #102B26;
        margin: 0 0 24px 0;
        text-align: center;
    }

    /* Intro Text */
    #shopify-section-{{ section.id }} .recommendations-intro-text {
        font-family: 'Gotham', sans-serif;
        font-size: 16px;
        font-weight: 400;
        line-height: 1.6;
        color: #102B26;
        margin-bottom: 32px;
        text-align: center;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }

    #shopify-section-{{ section.id }} .recommendations-intro-text p {
        margin: 0 0 16px 0;
    }

    #shopify-section-{{ section.id }} .recommendations-intro-text p:last-child {
        margin-bottom: 0;
    }

    /* CTA Button */
    #shopify-section-{{ section.id }} .recommendations-cta-button {
        display: block;
        margin: 0 auto 60px;
        padding: 16px 32px;
        background: #E98C36;
        color: white;
        border: none;
        border-radius: 999px;
        font-family: 'Gotham', sans-serif;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    #shopify-section-{{ section.id }} .recommendations-cta-button:hover {
        opacity: 0.9;
    }

    /* Content Layout */
    #shopify-section-{{ section.id }} .quiz-recommendations-content-layout {
        display: flex;
        align-items: flex-start;
        gap: 40px;
        padding: 0 60px 80px;
        background: #f7f7fc;
    }

    /* Left Column - Content */
    #shopify-section-{{ section.id }} .quiz-recommendations-content-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 800px;
    }

    /* Right Column - Upsell & Cart Summary (Desktop) */
    #shopify-section-{{ section.id }} .quiz-recommendations-cart-column {
        width: 380px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    /* Mobile Sticky Bar */
    #shopify-section-{{ section.id }} .quiz-recommendations-mobile-sticky-bar {
        display: none;
    }

    .gift-product-card {
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 30px;
        border: 1px solid #e5e7eb;
    }

    @media (max-width: 767px) {
        .gift-product-card {
            margin-bottom: 24px;
        }
    }

    .gift-card-body {
        display: flex;
        flex-direction: column;
    }

    .gift-banner-top {
        background: var(--highlight-color, #d4ff6a);
        color: #000;
        text-align: center;
        padding: 8px 16px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .gift-card-main {
        display: flex;
        gap: 16px;
        padding: 16px 0;
    }

    .gift-card-image {
        width: 100px;
        height: 140px;
        background: #f9fafb;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
        align-self: flex-start;
    }

    .gift-card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .gift-card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .gift-product-title {
        font-size: 20px;
        color: #111827;
        text-decoration: none;
        line-height: 1.3;
        transition: color 0.2s;
    }

    .gift-product-title:hover {
        color: var(--primary-color, #000);
    }

    .gift-product-title-mobile {
        display: none;
    }

    .gift-badge-text {
        font-size: 13px;
        color: #10b981;
        font-weight: 600;
        margin: 0;
    }

    .gift-product-description {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.4;
    }

    /* Tiered Gift System Styles */
    .gift-tiers-container {
        margin-bottom: 30px;
    }

    .gift-progress-section {
        background: #fff;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
    }

    .gift-progress-header {
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .gift-progress-label {
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        flex: 1;
    }

    .gift-toggle-btn {
        display: none;
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        color: #6b7280;
        transition: transform 0.3s ease;
        z-index: 10;
        position: relative;
        -webkit-tap-highlight-color: transparent;
    }

    .gift-toggle-btn[aria-expanded="true"] .gift-toggle-arrow {
        transform: rotate(180deg);
    }

    .gift-toggle-arrow {
        transition: transform 0.3s ease;
    }

    .gift-progress-bar-container {
        position: relative;
        height: 12px;
        background: var(--gift-progress-bar-bg-color, #e5e7eb);
        border-radius: 6px;
        overflow: visible;
    }

    .gift-progress-bar {
        height: 100%;
        background: var(--gift-progress-bar-color, #d4ff6a);
        border-radius: 6px;
        transition: width 0.4s ease-out;
    }

    .gift-progress-milestones {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100%;
        pointer-events: none;
    }

    .gift-milestone {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 24px;
        height: 24px;
        background: #fff;
        border: 3px solid #e5e7eb;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 700;
        color: #9ca3af;
        transition: all 0.3s ease;
        z-index: 1;
    }

    .gift-milestone.reached {
        background: var(--gift-milestone-color, #d4ff6a);
        border-color: var(--gift-milestone-color, #d4ff6a);
        color: #166534;
    }

    .gift-milestone.reached::after {
        content: '✓';
        font-size: 12px;
    }

    .gift-milestone:not(.reached)::after {
        content: attr(data-tier);
    }

    .gift-cards-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .gift-tier-card {
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        opacity: 0.5;
        transition: all 0.3s ease;
    }

    .gift-tier-card.unlocked {
        opacity: 1;
        transform: scale(1);
        border: none;
    }

    .gift-tier-card.locked .gift-card-main {
        filter: grayscale(50%);
    }

    .gift-tier-banner {
        background: #e5e7eb;
        color: #6b7280;
        text-align: center;
        padding: 8px 16px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }

    .gift-tier-card.unlocked .gift-tier-banner {
        background: var(--gift-progress-bar-color, #d4ff6a);
        color: #000;
    }

    .gift-tier-card .gift-card-main {
        display: flex;
        gap: 16px;
        padding: 16px;
    }

    .gift-tier-card .gift-card-image {
        width: 80px;
        height: 80px;
        background: #f9fafb;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .gift-tier-card .gift-card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .gift-tier-card .gift-card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 4px;
    }

    .gift-tier-card .gift-product-title {
        font-size: 16px;
        margin: 0;
    }

    .gift-tier-price {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 4px;
    }

    .gift-tier-original-price {
        text-decoration: line-through;
        color: #9ca3af;
        font-size: 14px;
    }

    .gift-tier-free-label {
        color: #16a34a;
        font-weight: 700;
        font-size: 14px;
    }

    .gift-tier-locked-text {
        font-size: 12px;
        color: #9ca3af;
        font-style: italic;
    }

    .gift-tier-card.unlocked .gift-tier-locked-text {
        display: none;
    }

    /* Gift price display in cart */
    .cart-gift-price {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px!important;
    }

    .cart-gift-original-price {
        text-decoration: line-through;
        color: #9ca3af;
        font-size: 12px;
    }

    .cart-gift-free-price {
        color: #16a34a;
        font-size: 14px;
    }

    @media (max-width: 767px) {
        .gift-tiers-container {
            margin-bottom: 24px;
        }

        .gift-progress-section {
            padding: 12px;
            margin-bottom: 0;
        }

        .gift-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gift-cards-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding: 0;
        }

        .gift-cards-container.expanded {
            max-height: 1000px;
            padding-top: 12px;
        }

        .gift-tier-card .gift-card-main {
            padding: 12px;
        }

        .gift-tier-card .gift-card-image {
            width: 60px;
            height: 60px;
        }

        .gift-tier-card .gift-product-title {
            font-size: 14px;
        }

        .gift-milestone {
            width: 20px;
            height: 20px;
            font-size: 9px;
        }
    }

    #shopify-section-{{ section.id }} .recommendations-title {
        font-family: 'Gotham', sans-serif;
        font-size: 24px;
        font-weight: 600;
        color: #102B26;
        margin: 0 0 6px 0;
        text-align: left;
    }

    #shopify-section-{{ section.id }} .recommendations-subtitle {
        font-family: 'Gotham', sans-serif;
        font-size: 14px;
        color: #102B26;
        line-height: 1.5;
        margin-bottom: 20px;
    }

    #shopify-section-{{ section.id }} .recommendations-subtitle p:last-of-type {
        margin-bottom: 0;
    }

    #shopify-section-{{ section.id }} .recommendations-section {
        margin-top: 10px;
    }

    #shopify-section-{{ section.id }} .section-title {
        font-family: 'Gotham', sans-serif;
        font-size: 22px;
        font-weight: 600;
        color: #102B26;
        margin: 0 0 16px 0;
        line-height: 1.3;
        text-align: center;
        background: var(--highlight-color, #d4ff6a);
        padding: 5px 10px;
        border-radius: 8px;
    }

    .section-description {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .section-description p {
        margin: 0 0 8px 0;
    }

    .section-description p:last-child {
        margin-bottom: 0;
    }

    .section-divider {
        border: none;
        border-top: 1px solid #e5e7eb;
        margin: 0;
    }

    .recommended-product-card {
        background: #fff;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
        display: flex;
        gap: 16px;
        position: relative;
        opacity: 1;
        border: 1px solid #e5e7eb;
    }

    .product-number-badge {
        position: absolute;
        top: -12px;
        left: -12px;
        background: var(--primary-color, #102B26);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 700;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .product-bogo-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: var(--highlight-color, #d4ff6a);
        color: #000;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 8px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        z-index: 10;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .product-card-image {
        width: 120px;
        height: 160px;
        background: #f9fafb;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
        align-self: flex-start;
        position: relative;
    }

    .product-card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .product-card-mobile-title {
        display: none;
    }

    .product-card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .product-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        gap: 12px;
    }

    .product-card-title-wrapper {
        flex: 1;
    }

    .product-card-title {
        font-size: 20px;
        font-weight: 600;
        color: #102B26;
        margin: 0 0 10px 0;
        line-height: 1.3;
    }

    .product-card-description {
        font-size: 12px;
        color: #102B26;
        line-height: 1.3;
        margin: 0;
        font-weight: 300!important;
    }

    .product-card-description span {
        font-size: 12px;
        font-weight: 300!important;
    }

    .product-card-description p {
        margin: 0 0 8px 0;
    }

    .product-card-description p:last-child {
        margin-bottom: 0;
    }

    .product-remove-btn {
        background: transparent;
        color: #9ca3af;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.2s;
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
    }

    .product-remove-btn:hover {
        background: #f3f4f6;
        color: #6b7280;
    }

    .product-remove-btn svg {
        width: 20px;
        height: 20px;
    }

    .recommended-product-card.removed .product-remove-btn {
        display: none;
    }

    .product-variant-selector {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 12px;
    }

    .variant-label {
        font-size: 11px;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }

    .variant-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .variant-button {
        padding: 8px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 13px;
        background: #fff;
        cursor: pointer;
        color: #102B26;
        font-family: inherit;
        font-weight: 400;
        transition: all 0.2s;
        min-width: 60px;
        text-align: center;
    }

    .variant-button:hover:not(:disabled) {
        border-color: #d1d5db;
        background: #f9fafb;
    }

    .variant-button.selected {
        border-color: #a6a8de;
        background: #fff;
        color: #102B26;
    }

    .variant-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        color: #9ca3af;
    }

    .variant-button:focus {
        outline: none;
        border-color: var(--primary-color, #102B26);
    }

    .product-quantity-selector {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .quantity-label {
        font-size: 11px;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }

    .quantity-btn {
        background: #fff;
        border: none;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #374151;
        font-size: 18px;
        transition: background 0.2s;
    }

    .quantity-btn:hover {
        background: #f9fafb;
    }

    .quantity-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }

    .quantity-value {
        min-width: 32px;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
        color: #111827;
        border-left: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
    }

    .subscription-frequency-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .subscription-frequency-selector {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
    }

    .frequency-label {
        font-size: 11px;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .frequency-dropdown {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 13px;
        background: #fff;
        cursor: pointer;
        color: #102B26;
        font-family: inherit;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23374151' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 32px;
    }

    .frequency-dropdown:hover {
        border-color: #d1d5db;
    }

    .frequency-dropdown:focus {
        outline: none;
        border-color: var(--primary-color, #102B26);
    }

    .product-purchase-options-header {
        font-size: 11px;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .product-purchase-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .purchase-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        background: #fff;
        transition: all 0.2s;
        position: relative;
    }

    .purchase-option:hover {
        border-color: #d1d5db;
    }

    .purchase-option.selected {
        border-color: #a6a8de;
        background: #f1f1f9;
    }

    .purchase-option input[type="radio"] {
        width: 18px;
        height: 18px;
        margin-right: 12px;
        cursor: pointer;
        flex-shrink: 0;
        appearance: none;
        -webkit-appearance: none;
        border: 2px solid #e5e7eb;
        border-radius: 50%;
        background: white;
        position: relative;
        transition: all 0.2s;
    }

    .purchase-option input[type="radio"]:checked {
        border-color: #1a365d;
        background: white;
    }

    .purchase-option input[type="radio"]:checked::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #1a365d;
    }

    .purchase-option input[type="radio"]:focus {
        outline: 2px solid #1a365d;
        outline-offset: 2px;
    }

    .option-details {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .option-label {
        font-weight: 500;
        color: #102B26;
        font-size: 14px;
    }

    .option-price-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
    }

    .option-price-original {
        font-size: 13px;
        color: #9ca3af;
        text-decoration: line-through;
        font-weight: 400;
    }

    .option-price {
        font-size: 16px;
        font-weight: 600;
        color: #102B26;
        white-space: nowrap;
    }

    .product-discount-badge-subscribe {
        background: #E98C36;
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .product-price-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 12px;
    }

    .product-price-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .product-price-original {
        font-size: 13px;
        color: #9ca3af;
        text-decoration: line-through;
        font-weight: 400;
    }

    .product-price-only {
        font-size: 16px;
        font-weight: 600;
        color: var(--primary-color, #102B26);
    }

    .product-discount-badge {
        display: inline-block;
        background: var(--highlight-color, #d4ff6a);
        color: #000;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .product-add-btn {
        background: var(--button-color, #a6a8de);
        color: var(--button-text-color, white);
        border: none;
        padding: 8px 20px;
        border-radius: 5rem;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        z-index: 10;
        position: relative;
        align-self: flex-end;
    }

    .product-add-btn:hover {
        opacity: 0.9;
    }

    .product-add-btn-corner {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 5rem;
    }

    .recommended-product-card.removed .product-add-btn-corner {
        display: inline-flex !important;
    }

    #shopify-section-{{ section.id }} .cart-summary {
        background: #fff;
        border-radius: 12px;
        position: sticky;
        top: 20px;
        border: 1px solid #e5e7eb;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .cart-summary-header {
        margin-bottom: 10px;
        padding-bottom: 12px;
        border-bottom: 1px solid #e5e7eb;
    }

    .cart-header-content {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .cart-header-left {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #shopify-section-{{ section.id }} .cart-summary-title {
        font-family: 'Gotham', sans-serif;
        font-size: 18px;
        font-weight: 600;
        color: #102B26;
        margin: 0;
    }

    #shopify-section-{{ section.id }} .cart-item-count {
        font-family: 'Gotham', sans-serif;
        font-size: 14px;
        color: #6b7280;
        font-weight: 400;
    }

    .cart-header-total {
        display: none;
        font-size: 18px;
        font-weight: 600;
        color: #102B26;
    }

    .cart-toggle-btn {
        display: none;
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: #6b7280;
    }

    .cart-close-btn {
        display: none;
        position: absolute;
        top: 8px;
        right: 12px;
        background: #f3f4f6;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10000;
        color: #111827;
        transition: background 0.2s;
    }

    .cart-close-btn:hover {
        background: #e5e7eb;
    }

    .cart-arrow {
        transition: transform 0.3s ease;
    }

    .cart-summary.collapsed .cart-arrow {
        transform: rotate(180deg);
    }

    .cart-items {
        display: flex;
        flex-direction: column;
        gap: 0;
        margin-bottom: 10px;
    }

    .cart-subscription-group-header {
        font-size: 13px;
        font-weight: 600;
        color: #102B26;
        text-transform: capitalize;
        margin-top: 8px;
        margin-bottom: 6px;
    }

    .cart-subscription-item {
        padding-left: 12px;
    }

    .cart-subscription-item .cart-item-name {
        font-weight: 400;
    }

    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: start;
        position: relative;
        padding: 6px 0;
        border: none;
        border-bottom: none;
    }

    .cart-item-info {
        flex: 1;
    }

    .cart-item-name {
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        display: block;
        margin-bottom: 0;
    }

    .cart-item-meta {
        font-size: 11px;
        color: #102B26;
    }

    .cart-item-price {
        font-size: 14px;
        font-weight: 600;
        color: #102B26;
        text-align: right;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .cart-item-price-original {
        font-size: 13px;
        color: #9ca3af;
        text-decoration: line-through;
        font-weight: 400;
    }

    .cart-item-price-discounted {
        color: #000;
        font-weight: 600;
        background: var(--highlight-color, #d4ff6a);
        padding: 2px 6px;
        border-radius: 4px;
    }

    .cart-item-bogo {
        background: var(--highlight-color, #d4ff6a);
        padding: 8px;
        border-radius: 6px;
        margin: 2px 0;
        .cart-item-price {
            padding-right: 8px;
        }
    }

    .cart-item-bogo-label {
        font-size: 10px;
        font-weight: 700;
        color: #000;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: 6px;
    }

    .cart-item-remove {
        background: none;
        border: none;
        color: #9ca3af;
        font-size: 20px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: color 0.2s ease;
    }

    .cart-item-remove:hover {
        color: #ef4444;
    }

    .cart-item {
        padding-right: 0;
    }

    .cart-summary-divider {
        border-top: 1px solid #e5e7eb;
        margin: 12px 0;
    }

    .cart-summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        font-size: 14px;
        color: #6b7280;
    }

    .cart-summary-row.total {
        font-size: 16px;
        font-weight: 600;
        color: #102B26;
        padding-top: 8px;
    }

    .cart-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 12px;
        margin-bottom: 16px;
        border-top: 1px solid #e5e7eb;
        font-size: 16px;
        font-weight: 600;
        color: #102B26;
    }

    .cart-highlight-box-external {
        background: var(--highlight-color, #d4ff6a);
        padding: 12px 16px;
        border-radius: 6px;
        margin-top: 12px;
        font-size: 13px;
        line-height: 1.4;
        color: #000;
        text-align: center;
        font-weight: 500;
    }

    .cart-highlight-box-external p {
        margin-bottom: 0;
    }

    .cart-highlight-box-external.cart-highlight-fullscreen {
        display: none;
    }

    .cart-highlight-box-external.mobile-only {
        margin: 12px 20px;
        width: calc(100% - 40px);
    }

    .desktop-only {
        display: block;
    }

    .mobile-only {
        display: none;
    }

    .quiz-btn-checkout {
        width: 100%;
        background: var(--checkout-button-color, #22c55e);
        color: var(--checkout-button-text-color, white);
        border: none;
        padding: 14px 24px;
        border-radius: var(--btn-border-radius, 5rem);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
        position: relative;
    }

    .quiz-btn-checkout:hover {
        opacity: 0.9;
    }

    .quiz-btn-checkout.loading {
        pointer-events: none;
        opacity: 0.7;
    }

    .quiz-btn-checkout.loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spinner 0.6s linear infinite;
    }

    @keyframes spinner {
        to {
            transform: rotate(360deg);
        }
    }

    .checkout-mobile {
        display: none;
    }

    /* Mobile Styles */
    @media (max-width: 1024px) {
        #shopify-section-{{ section.id }} .quiz-recommendations-wrapper {
            flex-direction: column;
            min-height: auto;
        }

        #shopify-section-{{ section.id }} .quiz-recommendations-header {
            padding: 20px 16px 0;
        }

        #shopify-section-{{ section.id }} .recommendations-feature-bar {
            gap: 16px;
            margin-bottom: 20px;
        }

        #shopify-section-{{ section.id }} .feature-item {
            gap: 6px;
        }

        #shopify-section-{{ section.id }} .feature-icon {
            width: 20px;
            height: 20px;
        }

        #shopify-section-{{ section.id }} .feature-text {
            font-size: 12px;
        }

        #shopify-section-{{ section.id }} .recommendations-sale-banner {
            font-size: 32px;
            margin-bottom: 20px;
        }

        #shopify-section-{{ section.id }} .recommendations-intro-text {
            font-size: 14px;
            margin-bottom: 24px;
            padding: 0;
        }

        #shopify-section-{{ section.id }} .recommendations-cta-button {
            margin-bottom: 40px;
            padding: 14px 28px;
            font-size: 14px;
        }

        #shopify-section-{{ section.id }} .quiz-recommendations-content-layout {
            flex-direction: column;
            padding: 0 16px 100px;
            gap: 24px;
        }

        #shopify-section-{{ section.id }} .quiz-recommendations-content-column {
            max-width: 100%;
        }

        #shopify-section-{{ section.id }} .quiz-recommendations-cart-column {
            display: none; /* Hide desktop cart on mobile */
        }

        #shopify-section-{{ section.id }} .limited-deal-banner {
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
            padding: 10px 12px;
        }

        #shopify-section-{{ section.id }} .limited-deal-timer {
            width: 100%;
            text-align: center;
        }

        #shopify-section-{{ section.id }} .upsell-package-card {
            padding: 16px;
        }

        #shopify-section-{{ section.id }} .upsell-title {
            font-size: 18px;
        }

        #shopify-section-{{ section.id }} .upsell-description {
            font-size: 13px;
        }

        #shopify-section-{{ section.id }} .upsell-button {
            padding: 12px 18px;
            font-size: 14px;
        }

        /* Mobile Sticky Bar */
        #shopify-section-{{ section.id }} .quiz-recommendations-mobile-sticky-bar {
            display: block;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            padding: 12px 20px;
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 100%;
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-price-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-price-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-price-label > span {
            font-family: 'Gotham', sans-serif;
            font-size: 14px;
            font-weight: 400;
            color: #102B26;
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-dropdown-toggle {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: #102B26;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-dropdown-toggle.expanded svg {
            transform: rotate(180deg);
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-price-values {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-original-price {
            font-family: 'Gotham', sans-serif;
            font-size: 13px;
            color: #9ca3af;
            text-decoration: line-through;
            font-weight: 400;
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-total {
            font-family: 'Gotham', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: #1a365d;
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-checkout {
            width: 100%;
            padding: 14px 24px;
            background: #1a365d;
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Gotham', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: opacity 0.2s;
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-checkout:hover {
            opacity: 0.9;
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-checkout svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        #shopify-section-{{ section.id }} .mobile-sticky-bar-subtext {
            font-family: 'Gotham', sans-serif;
            font-size: 12px;
            color: #102B26;
            text-align: center;
            font-weight: 700;
        }

        /* Mobile Cart Summary (Full Screen Overlay) */
        #shopify-section-{{ section.id }} .quiz-recommendations-cart-column.mobile-expanded {
            display: flex !important;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            z-index: 10000;
            background: white;
            padding: 20px;
            overflow-y: auto;
            flex-direction: column;
        }

        #shopify-section-{{ section.id }} .quiz-recommendations-cart-column.mobile-expanded .cart-summary {
            position: static;
            border: none;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
        }

        #shopify-section-{{ section.id }} .quiz-recommendations-cart-column.mobile-expanded .cart-summary-body {
            flex: 1;
            overflow-y: auto;
            padding-top: 16px;
        }

        /* Mobile Cart Header */
        #shopify-section-{{ section.id }} .quiz-recommendations-cart-column.mobile-expanded .cart-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 16px;
        }

        #shopify-section-{{ section.id }} .quiz-recommendations-cart-column.mobile-expanded .cart-close-btn {
            display: flex;
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f3f4f6;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10001;
            color: #111827;
        }

        .desktop-only {
            display: none;
        }

        .mobile-only {
            display: block;
        }


        .cart-highlight-box-external.mobile-only {
            background: white;
            width: 100%;
            margin: 0;
            padding: 12px;
        }

        .cart-highlight-box-external.mobile-only > * {
            background: var(--highlight-color, #d4ff6a);
            padding: 12px 16px;
            border-radius: 6px;
            display: inline-block;
        }
    }

    @media (max-width: 767px) {
        #shopify-section-{{ section.id }} .quiz-recommendations-content-column {
            padding: 20px 16px;
            padding-bottom: 100px;
        }

        .recommended-product-card {
            flex-direction: row;
            gap: 12px;
            padding: 12px;
        }

        .gift-card-main {
            flex-direction: column;
        }

        .product-card-image {
            width: 100px;
            height: 140px;
            flex-shrink: 0;
        }

        .gift-card-image {
            width: 100%;
            height: 180px;
        }

        .product-card-content {
            flex: 1;
            gap: 12px;
            min-width: 0;
        }

        .product-card-title {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .product-card-description {
            font-size: 11px;
            line-height: 1.4;
        }

        .variant-label,
        .quantity-label,
        .frequency-label {
            font-size: 10px;
        }

        .variant-buttons {
            gap: 6px;
        }

        .variant-button {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 50px;
        }

        .quantity-controls {
            width: auto;
        }

        .quantity-btn {
            width: 28px;
            height: 28px;
            font-size: 16px;
        }

        .quantity-value {
            min-width: 28px;
            font-size: 13px;
        }

        .frequency-dropdown {
            font-size: 12px;
            padding: 6px 8px;
        }

        .product-purchase-options-header {
            font-size: 10px;
            margin-bottom: 6px;
        }

        .purchase-option {
            padding: 10px 12px;
        }

        .option-label {
            font-size: 13px;
        }

        .option-price-original {
            font-size: 11px;
        }

        .option-price {
            font-size: 14px;
        }

        .product-discount-badge,
        .product-discount-badge-subscribe {
            font-size: 9px;
            padding: 3px 6px;
        }

        .product-card-mobile-title {
            display: block;
            font-size: 16px;
            font-weight: 600; 
            color: #102B26;
            line-height: 1.3;
            margin-bottom: 8px;
        }

        .product-card-title-desktop {
            display: none;
        }

        .gift-product-title-mobile {
            display: block;
            /*position: absolute;*/
            top: 0;
            left: 100%;
            width: calc(100vw - 180px);
            padding: 0 0 0 12px;
            font-size: 16px;
            font-weight: 600;
            color: #102B26;
            line-height: 1.3;
            margin-bottom: 0;
        }

        .gift-product-title-desktop {
            display: none;
        }
    }
    .checkout-subtext {
        font-size: 12px;
        text-align: center;
        margin-top: 12px;
    }
</style>

<script>
(function() {
    let cartItems = [];
    let initialized = false;
    let productStates = {};

    // BOGO configuration
    let bogoEnabled = false;
    let bogoProductHandles = [];
    let bogoBadgeText = 'BUY 1 GET 1 FREE';
    let bogoCartText = 'Buy 1 Get 1 Free';

    // Tiered Gift System configuration
    let giftTiersEnabled = false;
    let giftTiers = []; // Array of { tier, threshold, femaleHandle, maleHandle, bannerText, description, product: null, unlocked: false }
    let giftProgressText = '';
    let giftCompleteText = '';
    let currentGiftProducts = {}; // Track which gift products are in cart by tier
    let userGender = 'female'; // Default to female, will be set from quiz answers

    function initGiftTiers() {
        console.log('initGiftTiers called');
        const container = document.querySelector('[data-gift-tiers-enabled]');
        console.log('Gift tiers container found:', !!container);

        if (!container || container.dataset.giftTiersEnabled !== 'true') {
            console.log('Gift tiers NOT enabled');
            giftTiersEnabled = false;
            return;
        }

        console.log('Gift tiers ENABLED');
        giftTiersEnabled = true;
        giftProgressText = container.dataset.progressText || 'Spend [[remaining]] more to unlock your next gift!';
        giftCompleteText = container.dataset.completeText || 'You have unlocked all free gifts!';

        // Get user gender from QuizManager
        if (window.QuizManager && window.QuizManager.answers && window.QuizManager.answers.gender) {
            userGender = window.QuizManager.answers.gender.value === 'male' ? 'male' : 'female';
        }
        console.log('Gift tiers - User gender:', userGender);

        // Parse tier configurations
        giftTiers = [];
        for (let i = 1; i <= 3; i++) {
            const threshold = parseInt(container.dataset[`tier${i}Threshold`]) || 0;
            const femaleHandle = container.dataset[`tier${i}Female`] || '';
            const femaleVariantId = container.dataset[`tier${i}VariantFemale`] || '';
            const maleHandle = container.dataset[`tier${i}Male`] || '';
            const maleVariantId = container.dataset[`tier${i}VariantMale`] || '';
            const bannerText = container.dataset[`tier${i}Banner`] || `Tier ${i} Gift`;
            const description = container.dataset[`tier${i}Description`] || '';

            console.log(`Tier ${i}: threshold=${threshold}, femaleHandle=${femaleHandle}, maleHandle=${maleHandle}`);

            // Only add tier if threshold > 0 and at least one product is set
            if (threshold > 0 && (femaleHandle || maleHandle)) {
                giftTiers.push({
                    tier: i,
                    threshold,
                    femaleHandle,
                    femaleVariantId: femaleVariantId ? parseInt(femaleVariantId) : null,
                    maleHandle,
                    maleVariantId: maleVariantId ? parseInt(maleVariantId) : null,
                    bannerText,
                    description,
                    product: null,
                    variantId: null, // Will be set when product is fetched
                    unlocked: false
                });
            }
        }

        // Sort by threshold ascending
        giftTiers.sort((a, b) => a.threshold - b.threshold);
        console.log('Gift tiers configured:', giftTiers);
        console.log('Number of tiers:', giftTiers.length);

        // Fetch gift products
        giftTiers.forEach(tier => {
            const isMale = userGender === 'male' && tier.maleHandle;
            const handle = isMale ? tier.maleHandle : tier.femaleHandle;
            const specifiedVariantId = isMale ? tier.maleVariantId : tier.femaleVariantId;

            if (handle) {
                fetch(`/products/${handle}.js`)
                    .then(res => res.ok ? res.json() : null)
                    .then(product => {
                        if (product) {
                            tier.product = product;
                            // Use specified variant ID or default to first variant
                            if (specifiedVariantId) {
                                const variant = product.variants.find(v => v.id === specifiedVariantId);
                                tier.variantId = variant ? variant.id : product.variants[0].id;
                            } else {
                                tier.variantId = product.variants[0].id;
                            }
                            console.log(`Tier ${tier.tier} gift: ${product.title}, variant ID: ${tier.variantId}`);
                            renderGiftTiers();
                        }
                    })
                    .catch(err => console.error(`Error fetching gift product ${handle}:`, err));
            }
        });

        // Initial render
        renderGiftTiers();

        // Setup mobile toggle for gift cards (only once)
        const toggleBtn = document.querySelector('[data-gift-toggle]');
        const giftCardsContainer = document.querySelector('[data-gift-cards-container]');

        if (toggleBtn && giftCardsContainer && !toggleBtn.hasAttribute('data-toggle-initialized')) {
            toggleBtn.setAttribute('data-toggle-initialized', 'true');
            toggleBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
                toggleBtn.setAttribute('aria-expanded', String(!isExpanded));
                giftCardsContainer.classList.toggle('expanded', !isExpanded);
            });
        }
    }

    function getCartTotalForGifts() {
        // Calculate cart total for non-gift, non-bogo-free items
        // IMPORTANT: Returns total in shop's BASE currency (EUR) for threshold comparison
        let total = 0;
        cartItems.forEach(item => {
            if (item.isGift || item.isBogoFree) return;

            // Get price from the correct variant (this is in user's selected currency)
            let variantPrice;
            if (item.product.selectedVariant) {
                variantPrice = item.product.selectedVariant.price;
            } else {
                const variant = item.product.variants.find(v => v.id === parseInt(item.variantId));
                variantPrice = variant ? variant.price : item.product.variants[0].price;
            }

            // Apply subscription discount if applicable
            if (item.sellingPlanId && item.product.selling_plan_groups) {
                const sellingPlanGroup = item.product.selling_plan_groups[0];
                const sellingPlan = sellingPlanGroup?.selling_plans?.find(sp => sp.id == item.sellingPlanId);
                if (sellingPlan) {
                    variantPrice = calculateSubscriptionPrice(variantPrice, sellingPlan);
                }
            }

            total += variantPrice * item.quantity;
        });

        // Convert from cents to whole units
        let totalInCurrency = total / 100;

        // Convert back to base currency (EUR) if user is viewing in a different currency
        // Shopify.currency.rate is the conversion rate FROM base currency TO active currency
        // So to convert back to base currency, we divide by the rate
        const shopBaseCurrency = 'EUR';

        if (typeof Shopify !== 'undefined' && Shopify.currency && Shopify.currency.rate) {
            const rate = parseFloat(Shopify.currency.rate);
            const activeCurrency = Shopify.currency.active;

            // Only convert if rate is not 1 (meaning user is not viewing in base currency)
            if (rate && rate !== 1) {
                const originalTotal = totalInCurrency;
                totalInCurrency = totalInCurrency / rate;
                console.log(`Cart total converted: ${originalTotal.toFixed(2)} ${activeCurrency} -> ${totalInCurrency.toFixed(2)} ${shopBaseCurrency} (rate: ${rate})`);
            }
        }

        return totalInCurrency;
    }

    function updateGiftTiers() {
        if (!giftTiersEnabled || giftTiers.length === 0) return;

        const cartTotal = getCartTotalForGifts();
        console.log('Updating gift tiers - Cart total:', cartTotal);

        // Determine which tiers are now unlocked
        giftTiers.forEach(tier => {
            const wasUnlocked = tier.unlocked;
            tier.unlocked = cartTotal >= tier.threshold;

            // Handle adding/removing gifts
            if (tier.unlocked && !wasUnlocked && tier.product) {
                // Tier just became unlocked - add gift
                console.log(`Tier ${tier.tier} unlocked! Adding gift:`, tier.product.title);
                addGiftToCart(tier);
            } else if (!tier.unlocked && wasUnlocked && tier.product) {
                // Tier just became locked - remove gift
                console.log(`Tier ${tier.tier} locked! Removing gift:`, tier.product.title);
                removeGiftFromCart(tier);
            }
        });

        renderGiftTiers();
    }

    function addGiftToCart(tier) {
        // Gifts are no longer added to cartItems - they're only displayed visually
        // The actual gift products will be added by the backend/discount system
        if (!tier.product || !tier.variantId) return;

        currentGiftProducts[tier.tier] = tier.variantId;
        console.log(`Gift unlocked for tier ${tier.tier}:`, tier.product.title);
    }

    function removeGiftFromCart(tier) {
        // Gifts are no longer in cartItems - just update the tracking object
        delete currentGiftProducts[tier.tier];
        console.log(`Gift locked for tier ${tier.tier}`);
    }

    function renderGiftTiers() {
        if (!giftTiersEnabled) return;

        const cartTotal = getCartTotalForGifts();
        const progressBar = document.querySelector('[data-gift-progress-bar]');
        const progressLabel = document.querySelector('[data-gift-progress-label]');
        const milestonesContainer = document.querySelector('[data-gift-milestones]');
        const cardsContainer = document.querySelector('[data-gift-cards-container]');

        if (!progressBar || !progressLabel || !cardsContainer) return;

        // Find the next tier to unlock and max threshold
        const maxThreshold = giftTiers.length > 0 ? giftTiers[giftTiers.length - 1].threshold : 1;
        const nextTier = giftTiers.find(t => !t.unlocked);
        const allUnlocked = !nextTier;

        // Update progress bar
        const progressPercent = Math.min((cartTotal / maxThreshold) * 100, 100);
        progressBar.style.width = `${progressPercent}%`;

        // Helper to format currency for display (with conversion if available)
        // Note: amountInBaseCurrency is in EUR (shop's base currency)
        const formatCurrency = (amountInBaseCurrency) => {
            let cents = Math.round(amountInBaseCurrency * 100);

            // Convert from base currency (EUR) to user's active currency using Shopify.currency.rate
            if (typeof Shopify !== 'undefined' && Shopify.currency && Shopify.currency.rate) {
                const rate = parseFloat(Shopify.currency.rate);
                if (rate && rate !== 1) {
                    cents = Math.round(cents * rate);
                }
            }

            // Format using Shopify's money format
            const formatted = formatMoney(cents);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = formatted;
            return tempDiv.textContent || tempDiv.innerText || formatted;
        };

        // Update progress label
        if (allUnlocked) {
            progressLabel.textContent = giftCompleteText;
        } else if (nextTier) {
            const remaining = nextTier.threshold - cartTotal;
            let labelText = giftProgressText
                .replace('[[remaining]]', formatCurrency(remaining))
                .replace('[[current]]', formatCurrency(cartTotal))
                .replace('[[next_tier]]', formatCurrency(nextTier.threshold));
            progressLabel.textContent = labelText;
        }

        // Render milestones
        if (milestonesContainer) {
            milestonesContainer.innerHTML = '';
            giftTiers.forEach(tier => {
                const milestone = document.createElement('div');
                milestone.className = `gift-milestone ${tier.unlocked ? 'reached' : ''}`;
                milestone.dataset.tier = tier.tier;
                milestone.style.left = `${(tier.threshold / maxThreshold) * 100}%`;
                milestonesContainer.appendChild(milestone);
            });
        }

        // Render gift cards - preserve expanded state
        const wasExpanded = cardsContainer.classList.contains('expanded');
        cardsContainer.innerHTML = '';
        if (wasExpanded) {
            cardsContainer.classList.add('expanded');
        }
        giftTiers.forEach(tier => {
            if (!tier.product) return;

            const card = document.createElement('div');
            card.className = `gift-tier-card ${tier.unlocked ? 'unlocked' : 'locked'}`;
            card.dataset.tier = tier.tier;

            const amountNeeded = tier.threshold - cartTotal;
            const lockedText = `Spend ${formatCurrency(amountNeeded)} more to unlock`;

            // Get variant info for display
            const variant = tier.variantId ? tier.product.variants.find(v => v.id === tier.variantId) : tier.product.variants[0];
            const variantTitle = variant && variant.title !== 'Default Title' ? variant.title : '';
            // Use variant image if available, otherwise product featured image
            const imageUrl = variant?.featured_image?.src || tier.product.featured_image?.src || tier.product.featured_image || '';

            // Get variant price for display
            const variantPrice = variant ? variant.price : tier.product.variants[0].price;
            const formattedPrice = formatMoney(variantPrice);

            card.innerHTML = `
                <div class="gift-tier-banner">${tier.unlocked ? tier.bannerText : `Tier ${tier.tier} Gift`}</div>
                <div class="gift-card-main">
                    <div class="gift-card-image">
                        ${imageUrl ? `<img src="${imageUrl}" alt="${tier.product.title}">` : ''}
                    </div>
                    <div class="gift-card-content">
                        <h3 class="gift-product-title">${tier.product.title}${variantTitle ? ` - ${variantTitle}` : ''}</h3>
                        ${tier.description ? `<p class="gift-product-description">${tier.description}</p>` : ''}
                        <div class="gift-tier-price">
                            <span class="gift-tier-original-price">${formattedPrice}</span>
                            <span class="gift-tier-free-label">now ${formatMoney(0)}</span>
                        </div>
                        <span class="gift-tier-locked-text">${lockedText}</span>
                    </div>
                </div>
            `;

            cardsContainer.appendChild(card);
        });
    }

    function initRecommendations() {
        console.log('=== initRecommendations called ===');
        console.log('Initialized:', initialized);
        console.log('QuizManager exists:', !!window.QuizManager);
        console.log('Recommended products:', window.QuizManager?.recommendedProducts);

        if (initialized) {
            console.log('Already initialized, skipping');
            return;
        }

        if (!window.QuizManager) {
            console.warn('QuizManager not found, retrying in 500ms...');
            setTimeout(initRecommendations, 500);
            return;
        }

        if (!window.QuizManager.recommendedProducts || window.QuizManager.recommendedProducts.length === 0) {
            console.warn('No recommended products found, retrying in 500ms...');
            console.log('QuizManager state:', {
                answers: window.QuizManager.answers,
                recommendedProducts: window.QuizManager.recommendedProducts
            });
            setTimeout(initRecommendations, 500);
            return;
        }

        let productHandles = window.QuizManager.recommendedProducts;
        console.log('Product handles from QuizManager:', productHandles);
        console.log('Number of products:', productHandles.length);

        // Get custom sort order from data attribute
        const recommendationsSectionState = document.querySelector('[data-recommendations]');
        const sortOrder = recommendationsSectionState?.dataset.productSortOrder;

        // Load BOGO settings
        bogoEnabled = recommendationsSectionState?.dataset.bogoEnabled === 'true';
        const bogoProductsData = recommendationsSectionState?.dataset.bogoProducts;
        bogoProductHandles = bogoProductsData ? bogoProductsData.split(',').map(h => h.trim()).filter(h => h) : [];
        bogoBadgeText = recommendationsSectionState?.dataset.bogoBadgeText || 'BUY 1 GET 1 FREE';
        bogoCartText = recommendationsSectionState?.dataset.bogoCartText || 'Buy 1 Get 1 Free';
        console.log('BOGO settings loaded:', { bogoEnabled, bogoProductHandles, bogoBadgeText, bogoCartText });

        // Initialize tiered gift system
        initGiftTiers();

        // Process currency placeholders in highlight text
        processHighlightTextCurrency();

        if (sortOrder && sortOrder.trim() !== '') {
            const sortOrderHandles = sortOrder.split(',').map(h => h.trim()).filter(h => h);
            console.log('Custom sort order:', sortOrderHandles);

            // Reorder productHandles based on sortOrder
            // First, add products from sortOrder that are in recommendedProducts
            const orderedHandles = [];
            const remainingHandles = [...productHandles];

            sortOrderHandles.forEach(handle => {
                const index = remainingHandles.indexOf(handle);
                if (index !== -1) {
                    orderedHandles.push(handle);
                    remainingHandles.splice(index, 1);
                }
            });

            // Then add any remaining recommended products not in sortOrder
            productHandles = [...orderedHandles, ...remainingHandles];
            console.log('Reordered product handles:', productHandles);
        }

        const topPicksContainer = document.querySelector('[data-section-products="top-picks"]');
        const additionalContainer = document.querySelector('[data-section-products="additional"]');
        const accessoriesContainer = document.querySelector('[data-section-products="accessories"]');
        const giftProductHandle = document.querySelector('[data-gift-product]')?.dataset.giftProduct;

        console.log('Containers found:', {
            topPicks: !!topPicksContainer,
            additional: !!additionalContainer,
            accessories: !!accessoriesContainer
        });

        if (!topPicksContainer || !additionalContainer || !accessoriesContainer) {
            console.error('Section containers not found!', {
                topPicks: topPicksContainer,
                additional: additionalContainer,
                accessories: accessoriesContainer
            });
            // Retry after a short delay
            setTimeout(initRecommendations, 500);
            return;
        }

        if (productHandles.length === 0) {
            console.warn('No product handles to fetch');
            return;
        }

        console.log('Starting product fetch for', productHandles.length, 'products');
        initialized = true;

        // Fetch quiz recommended products
        const fetchPromises = productHandles.map(handle => {
            if (!handle) return Promise.resolve(null);
            console.log('Fetching product:', handle);
            return fetch(`/products/${handle}.js`)
                .then(response => response.ok ? response.json() : null)
                .catch(() => null);
        });

        Promise.all(fetchPromises).then(products => {
            console.log('Fetched products:', products);
            console.log('Valid products (not null):', products.filter(p => p !== null).length);
            
            // Filter out null products
            const validProducts = products.filter(p => p !== null);
            
            if (validProducts.length === 0) {
                console.error('No valid products fetched!');
                return;
            }
            
            // Section 1: Top 3 picks (auto-added to cart)
            const topPicks = validProducts.slice(0, 3);
            console.log('Top picks (Section 1):', topPicks.length, 'products');
            
            topPicks.forEach((product, index) => {
                if (!product || !product.id) {
                    console.error('Invalid product at index', index, product);
                    return;
                }
                
                console.log('Creating product card for:', product.title, product.id);
                productStates[product.id] = { removed: false, quantity: 1 };
                const productCard = createProductCard(product, 'top-picks', index + 1);
                
                if (!productCard) {
                    console.error('Failed to create product card for:', product.title);
                    return;
                }
                
                topPicksContainer.appendChild(productCard);

                const hasSubscription = product.selling_plan_groups && product.selling_plan_groups.length > 0;
                let initialSellingPlanId = null;

                // If BOGO is enabled, default to Buy Once (null selling plan)
                // Otherwise, default to subscription if available
                if (hasSubscription && !bogoEnabled) {
                    initialSellingPlanId = product.selling_plan_groups[0].selling_plans[0].id;
                }

                // Get the variant ID that was set by createProductCard (the most expensive one)
                const selectedVariantId = parseInt(productCard.dataset.variantId);

                // Auto-add to cart with the same variant that's selected in the card
                addToCart(selectedVariantId, 1, product, initialSellingPlanId);
            });

            // Section 2: Additional recommendations (not auto-added)
            const additionalProducts = validProducts.slice(3);
            console.log('Additional products (Section 2):', additionalProducts.length, 'products');
            
            additionalProducts.forEach((product) => {
                if (!product || !product.id) {
                    console.error('Invalid additional product:', product);
                    return;
                }
                
                console.log('Creating additional product card for:', product.title);
                productStates[product.id] = { removed: false, quantity: 1 };
                const productCard = createProductCard(product, 'additional');
                
                if (!productCard) {
                    console.error('Failed to create additional product card for:', product.title);
                    return;
                }
                
                additionalContainer.appendChild(productCard);
                // NOT auto-added to cart
            });
            
            // Update cart display after products are added
            console.log('Updating cart display...');
            updateCartDisplay();

            // Add legacy gift product if exists (only if tiered gifts are NOT enabled)
            if (giftProductHandle && !giftTiersEnabled) {
                fetch(`/products/${giftProductHandle}.js`)
                    .then(response => response.json())
                    .then(giftProduct => {
                        addToCart(giftProduct.variants[0].id, 1, giftProduct, null, true);
                    })
                    .catch(err => console.error('Error fetching gift product:', err));
            }

            // Trigger currency converter after all products are loaded
            setTimeout(() => {
                updateCurrencyConverter();
            }, 500);
        });

        // Section 3: Accessories (manual product list from settings)
        const accessoryHandles = {{ section.settings.accessories_products | json }};
        console.log('Accessory handles (Section 3):', accessoryHandles);
        
        if (accessoryHandles && accessoryHandles.length > 0) {
            const accessoryPromises = accessoryHandles.map(item => {
                // Handle both string handles and product objects
                const handle = typeof item === 'string' ? item : (item?.handle || null);
                if (!handle) return Promise.resolve(null);
                
                console.log('Fetching accessory product:', handle);
                return fetch(`/products/${handle}.js`)
                    .then(response => response.ok ? response.json() : null)
                    .catch(() => null);
            });

            Promise.all(accessoryPromises).then(accessories => {
                console.log('Fetched accessories:', accessories);
                accessories.forEach((product) => {
                    if (!product) return;
                    productStates[product.id] = { removed: false, quantity: 1 };
                    const productCard = createProductCard(product, 'accessories');
                    accessoriesContainer.appendChild(productCard);
                    // NOT auto-added to cart
                });

                // Trigger currency converter after accessories are loaded
                setTimeout(() => {
                    updateCurrencyConverter();
                }, 500);
            });
        }
    }

    function isBogoEligible(product) {
        if (!bogoEnabled || !product) return false;
        return bogoProductHandles.includes(product.handle);
    }

    function formatMoney(cents) {
        // Get active currency from Shopify object
        const activeCurrency = (typeof Shopify !== 'undefined' && Shopify.currency && Shopify.currency.active)
            ? Shopify.currency.active
            : 'USD';

        // Convert cents to decimal amount
        const amount = cents / 100;

        // Format using Intl.NumberFormat which handles currency symbols automatically
        let formattedPrice = '';
        try {
            formattedPrice = new Intl.NumberFormat('en', {
                style: 'currency',
                currency: activeCurrency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        } catch (e) {
            // Fallback if currency code is invalid
            console.warn('Currency formatting failed for', activeCurrency, e);
            formattedPrice = activeCurrency + ' ' + amount.toFixed(2);
        }

        // Return HTML with money class and data attributes for currency converters
        // Data attribute uses the shop's base currency (usually the first price loaded)
        return `<span class="money" data-currency-${activeCurrency}="${amount.toFixed(2)}">${formattedPrice}</span>`;
    }

    function updateCurrencyConverter() {
        // Trigger currency converter to update prices if available
        if (typeof Currency !== 'undefined' && typeof Currency.convertAll !== 'undefined') {
            try {
                const shopCurrency = (typeof Shopify !== 'undefined' && Shopify.currency)
                    ? Shopify.currency.active
                    : 'USD';
                Currency.convertAll(shopCurrency, '[name=currencies]');
            } catch (e) {
                console.log('Currency conversion update failed:', e);
            }
        }
        // Also try alternate method for different currency converter apps
        if (window.CRISP && window.CRISP.Currency && typeof window.CRISP.Currency.convert === 'function') {
            window.CRISP.Currency.convert();
        }
    }

    function processHighlightTextCurrency() {
        // Find all highlight text elements with the data attribute
        const highlightElements = document.querySelectorAll('[data-highlight-text]');

        highlightElements.forEach(element => {
            let html = element.innerHTML;

            // Find all [[amount:XXX]] patterns where XXX is the EUR amount
            const pattern = /\[\[amount:(\d+(?:\.\d+)?)\]\]/g;

            html = html.replace(pattern, (match, eurAmount) => {
                const amountInEur = parseFloat(eurAmount);

                // Convert EUR amount to user's currency using Shopify.currency.rate
                let centsInUserCurrency = Math.round(amountInEur * 100);

                if (typeof Shopify !== 'undefined' && Shopify.currency && Shopify.currency.rate) {
                    const rate = parseFloat(Shopify.currency.rate);
                    if (rate && rate !== 1) {
                        centsInUserCurrency = Math.round(centsInUserCurrency * rate);
                    }
                }

                // Format the amount using formatMoney and extract just the text
                const formattedHtml = formatMoney(centsInUserCurrency);
                // Create a temp element to extract text from the HTML
                const temp = document.createElement('div');
                temp.innerHTML = formattedHtml;
                return temp.textContent || temp.innerText || formattedHtml;
            });

            element.innerHTML = html;
        });
    }

    function createProductCard(product, section, number = null) {
        const card = document.createElement('div');
        card.className = 'recommended-product-card';
        card.dataset.productId = product.id;

        const hasSubscription = product.selling_plan_groups && product.selling_plan_groups.length > 0;
        const hasMultipleVariants = product.variants && product.variants.length > 1;
        const description = product.metafields?.custom?.description || product.description || '';

        // Find the most expensive variant (default selection)
        let defaultVariantIndex = 0;
        let defaultVariant = product.variants[0];
        if (hasMultipleVariants) {
            let maxPrice = product.variants[0].price;
            product.variants.forEach((variant, index) => {
                if (variant.price > maxPrice && variant.available) {
                    maxPrice = variant.price;
                    defaultVariantIndex = index;
                    defaultVariant = variant;
                }
            });
        }

        card.dataset.variantId = defaultVariant.id;
        card.dataset.section = section;

        let frequencyHTML = '';
        let purchaseOptionsHTML = '';
        let sellingPlans = [];

        // Variant selector HTML (if product has multiple variants) - Size buttons
        let variantSelectorHTML = '';
        if (hasMultipleVariants) {
            variantSelectorHTML = `
                <div class="product-variant-selector">
                    <span class="variant-label">SIZE</span>
                    <div class="variant-buttons">
                        ${product.variants.map((variant, index) => `
                            <button class="variant-button ${index === defaultVariantIndex ? 'selected' : ''}" 
                                    data-variant-id="${variant.id}" 
                                    data-variant-index="${index}"
                                    ${!variant.available ? 'disabled' : ''}>
                                ${variant.title}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        const quantityHTML = `
            <div class="product-quantity-selector">
                <span class="quantity-label">Qty</span>
                <div class="quantity-controls">
                    <button class="quantity-btn quantity-decrease" data-quantity-decrease>−</button>
                    <span class="quantity-value" data-quantity-value>1</span>
                    <button class="quantity-btn quantity-increase" data-quantity-increase>+</button>
                </div>
            </div>
        `;

        if (hasSubscription) {
            const sellingPlanGroup = product.selling_plan_groups[0];
            sellingPlans = sellingPlanGroup.selling_plans;

            frequencyHTML = `
                <div class="subscription-frequency-row">
                    ${quantityHTML}
                    <div class="subscription-frequency-selector">
                        <div class="frequency-label">Delivery Frequency</div>
                        <select class="frequency-dropdown" data-frequency-select>
                            ${sellingPlans.map((plan, index) => `
                                <option value="${plan.id}" data-plan-index="${index}" ${index === 0 ? 'selected' : ''}>
                                    ${plan.name}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                </div>
            `;

            const firstPlan = sellingPlans[0];
            const subscriptionPrice = calculateSubscriptionPrice(defaultVariant.price, firstPlan);

            // Check for compare_at_price discount on the Buy Once option
            const hasDiscount = defaultVariant.compare_at_price && defaultVariant.compare_at_price > defaultVariant.price;
            const discountPercent = hasDiscount ? Math.round(((defaultVariant.compare_at_price - defaultVariant.price) / defaultVariant.compare_at_price) * 100) : 0;
            const discountBadge = hasDiscount ? `<span class="product-discount-badge">${discountPercent}% OFF</span>` : '';

            // If BOGO is active, make "Buy Once" the default option, otherwise "Subscribe" is default
            const defaultToBuyOnce = bogoEnabled;
            
            // Calculate subscription discount percentage
            const subscriptionDiscountPercent = Math.round(((defaultVariant.price - subscriptionPrice) / defaultVariant.price) * 100);
            const subscriptionDiscountBadge = subscriptionDiscountPercent > 0 ? `<span class="product-discount-badge product-discount-badge-subscribe">SAVE ${subscriptionDiscountPercent}%</span>` : '';
            
            // Format prices for display
            const subscriptionOriginalPrice = formatMoney(defaultVariant.price);
            const subscriptionDiscountedPrice = formatMoney(subscriptionPrice);
            const onetimeOriginalPrice = hasDiscount ? formatMoney(defaultVariant.compare_at_price) : '';
            const onetimeDiscountedPrice = formatMoney(defaultVariant.price);

            purchaseOptionsHTML = `
                <div class="product-purchase-options-header">SUBSCRIBE AND SAVE 15%</div>
                <div class="product-purchase-options">
                    <label class="purchase-option${defaultToBuyOnce ? '' : ' selected'}" data-option="subscription">
                        <input type="radio" name="purchase_${product.id}" value="subscription"
                               data-selling-plan="${firstPlan.id}"${defaultToBuyOnce ? '' : ' checked'}>
                        <div class="option-details">
                            <span class="option-label">Subscribe</span>
                        </div>
                        <div class="option-price-wrapper">
                            ${hasDiscount ? `<span class="option-price-original">${subscriptionOriginalPrice}</span>` : ''}
                            <span class="option-price">${subscriptionDiscountedPrice}</span>
                            ${subscriptionDiscountBadge}
                        </div>
                    </label>
                    <label class="purchase-option${defaultToBuyOnce ? ' selected' : ''}" data-option="onetime">
                        <input type="radio" name="purchase_${product.id}" value="onetime"${defaultToBuyOnce ? ' checked' : ''}>
                        <div class="option-details">
                            <span class="option-label">Buy Once</span>
                        </div>
                        <div class="option-price-wrapper">
                            ${hasDiscount ? `<span class="option-price-original">${onetimeOriginalPrice}</span>` : ''}
                            <span class="option-price">${onetimeDiscountedPrice}</span>
                            ${discountBadge}
                        </div>
                    </label>
                </div>
            `;
        } else {
            // Check for compare_at_price discount
            const hasDiscount = defaultVariant.compare_at_price && defaultVariant.compare_at_price > defaultVariant.price;
            const discountPercent = hasDiscount ? Math.round(((defaultVariant.compare_at_price - defaultVariant.price) / defaultVariant.compare_at_price) * 100) : 0;
            const discountBadge = hasDiscount ? `<span class="product-discount-badge">${discountPercent}% OFF</span>` : '';

            const onetimeOriginalPrice = hasDiscount ? formatMoney(defaultVariant.compare_at_price) : '';
            const onetimeDiscountedPrice = formatMoney(defaultVariant.price);
            
            purchaseOptionsHTML = `
                <div class="product-price-row">
                    ${quantityHTML}
                    <div class="product-price-wrapper">
                        ${hasDiscount ? `<span class="product-price-original">${onetimeOriginalPrice}</span>` : ''}
                        <span class="product-price-only">${onetimeDiscountedPrice}</span>
                        ${discountBadge}
                    </div>
                </div>
            `;
        }

        const isBogo = isBogoEligible(product);

        card.innerHTML = `
            ${number ? `<div class="product-number-badge">${number}</div>` : ''}
            <button class="product-remove-btn" data-remove-btn style="${section === 'top-picks' ? '' : 'display: none;'}" aria-label="Remove product">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M5 5L15 15M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="product-card-image">
                ${isBogo ? `<div class="product-bogo-badge">${bogoBadgeText}</div>` : ''}
                <img src="${product.featured_image || ''}" alt="${product.title}">
                <h3 class="product-card-mobile-title">${product.title}</h3>
            </div>
            <div class="product-card-content">
                <div class="product-card-header">
                    <div class="product-card-title-wrapper">
                        <h3 class="product-card-title product-card-title-desktop">${product.title}</h3>
                        ${description ? `<div class="product-card-description">${description}</div>` : ''}
                    </div>
                </div>
                ${variantSelectorHTML}
                ${frequencyHTML}
                ${purchaseOptionsHTML}
            </div>
            <button class="product-add-btn product-add-btn-corner" data-add-btn style="${section === 'top-picks' ? 'display: none;' : ''}">
                Add
            </button>
        `;

        card.dataset.sellingPlans = JSON.stringify(sellingPlans);
        card.dataset.productData = JSON.stringify(product);
        card.dataset.selectedVariantPrice = defaultVariant.price;
        card.dataset.isBogo = isBogo;

        // Variant selector event listener (size buttons)
        if (hasMultipleVariants) {
            const variantButtons = card.querySelectorAll('.variant-button');
            variantButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (button.disabled) return;
                    
                    const selectedVariantId = parseInt(button.dataset.variantId);
                    const selectedVariantIndex = parseInt(button.dataset.variantIndex);
                    const selectedVariant = product.variants[selectedVariantIndex];
                    
                    // Update button states
                    variantButtons.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');

                    // Update card's variant ID and store selected variant data
                    card.dataset.variantId = selectedVariantId;
                    card.dataset.selectedVariantPrice = selectedVariant.price;

                    // Calculate discount badge for new variant
                    const hasVariantDiscount = selectedVariant.compare_at_price && selectedVariant.compare_at_price > selectedVariant.price;
                    const variantOriginalPrice = hasVariantDiscount ? formatMoney(selectedVariant.compare_at_price) : '';
                    const variantDiscountedPrice = formatMoney(selectedVariant.price);
                    const variantDiscountPercent = hasVariantDiscount ? Math.round(((selectedVariant.compare_at_price - selectedVariant.price) / selectedVariant.compare_at_price) * 100) : 0;
                    const variantDiscountBadge = hasVariantDiscount ? `<span class="product-discount-badge">${variantDiscountPercent}% OFF</span>` : '';

                    // Update prices based on new variant
                    const priceWrapper = card.querySelector('.product-price-wrapper');
                    const subscriptionPriceWrapper = card.querySelector('[data-option="subscription"] .option-price-wrapper');
                    const onetimePriceWrapper = card.querySelector('[data-option="onetime"] .option-price-wrapper');

                    if (priceWrapper && !hasSubscription) {
                        priceWrapper.innerHTML = `
                            ${hasVariantDiscount ? `<span class="product-price-original">${variantOriginalPrice}</span>` : ''}
                            <span class="product-price-only">${variantDiscountedPrice}</span>
                            ${variantDiscountBadge}
                        `;
                    }

                    if (subscriptionPriceWrapper && onetimePriceWrapper && hasSubscription) {
                        const sellingPlanGroup = product.selling_plan_groups[0];
                        const currentPlanSelect = card.querySelector('[data-frequency-select]');
                        let currentPlan = sellingPlanGroup.selling_plans[0];

                        if (currentPlanSelect) {
                            const currentPlanIndex = parseInt(currentPlanSelect.options[currentPlanSelect.selectedIndex].dataset.planIndex);
                            currentPlan = sellingPlanGroup.selling_plans[currentPlanIndex];
                        }

                        const subscriptionPrice = calculateSubscriptionPrice(selectedVariant.price, currentPlan);
                        const subscriptionDiscountPercent = Math.round(((selectedVariant.price - subscriptionPrice) / selectedVariant.price) * 100);
                        const subscriptionDiscountBadge = subscriptionDiscountPercent > 0 ? `<span class="product-discount-badge product-discount-badge-subscribe">SAVE ${subscriptionDiscountPercent}%</span>` : '';
                        
                        subscriptionPriceWrapper.innerHTML = `
                            ${hasVariantDiscount ? `<span class="option-price-original">${variantOriginalPrice}</span>` : ''}
                            <span class="option-price">${formatMoney(subscriptionPrice)}</span>
                            ${subscriptionDiscountBadge}
                        `;
                        
                        onetimePriceWrapper.innerHTML = `
                            ${hasVariantDiscount ? `<span class="option-price-original">${variantOriginalPrice}</span>` : ''}
                            <span class="option-price">${variantDiscountedPrice}</span>
                            ${variantDiscountBadge}
                        `;
                    }

                    // Trigger currency converter update
                    updateCurrencyConverter();

                    // Update cart if product is already added
                    const itemInCart = cartItems.find(item => item.product.id === product.id);
                    if (itemInCart) {
                        const currentQty = productStates[product.id].quantity || 1;
                        const selectedOption = card.querySelector('input[type="radio"]:checked');
                        const sellingPlanId = selectedOption?.dataset.sellingPlan || null;

                        // Remove old variant from cart
                        cartItems = cartItems.filter(item => item.product.id !== product.id);

                        // Create updated product with selected variant
                        const updatedProduct = {
                            ...product,
                            selectedVariant: selectedVariant
                        };

                        // Add new variant to cart
                        addToCart(selectedVariantId, currentQty, updatedProduct, sellingPlanId);
                    }
                });
            });
        }

        const decreaseBtn = card.querySelector('[data-quantity-decrease]');
        const increaseBtn = card.querySelector('[data-quantity-increase]');
        const quantityValue = card.querySelector('[data-quantity-value]');

        decreaseBtn.addEventListener('click', () => {
            let currentQty = parseInt(quantityValue.textContent);
            if (currentQty > 1) {
                currentQty--;
                quantityValue.textContent = currentQty;
                productStates[product.id].quantity = currentQty;

                const selectedOption = card.querySelector('input[type="radio"]:checked');
                const sellingPlanId = selectedOption?.dataset.sellingPlan || null;
                const selectedVariantId = parseInt(card.dataset.variantId);

                // Only update cart if product is in cart (top-picks section or manually added)
                const itemInCart = cartItems.find(item => parseInt(item.variantId) === selectedVariantId);
                if (itemInCart) {
                    // Use the product from cart which may have selectedVariant
                    const productToUpdate = itemInCart.product.selectedVariant ? itemInCart.product : product;
                    updateCartItem(selectedVariantId, currentQty, productToUpdate, sellingPlanId);
                }
            }
            decreaseBtn.disabled = currentQty <= 1;
        });

        increaseBtn.addEventListener('click', () => {
            let currentQty = parseInt(quantityValue.textContent);
            currentQty++;
            quantityValue.textContent = currentQty;
            productStates[product.id].quantity = currentQty;

            const selectedOption = card.querySelector('input[type="radio"]:checked');
            const sellingPlanId = selectedOption?.dataset.sellingPlan || null;
            const selectedVariantId = parseInt(card.dataset.variantId);

            // Only update cart if product is in cart (top-picks section or manually added)
            const itemInCart = cartItems.find(item => parseInt(item.variantId) === selectedVariantId);
            if (itemInCart) {
                // Use the product from cart which may have selectedVariant
                const productToUpdate = itemInCart.product.selectedVariant ? itemInCart.product : product;
                updateCartItem(selectedVariantId, currentQty, productToUpdate, sellingPlanId);
            }

            decreaseBtn.disabled = false;
        });

        const removeBtn = card.querySelector('[data-remove-btn]');
        if (removeBtn) {
            removeBtn.addEventListener('click', () => {
                const selectedVariantId = card.dataset.variantId;
                removeProductFromCart(product, selectedVariantId);
            });
        }

        const addBtn = card.querySelector('[data-add-btn]');
        if (addBtn) {
            addBtn.addEventListener('click', () => {
                productStates[product.id].removed = false;
                card.classList.remove('removed');
                addBtn.style.display = 'none';

                const removeBtn = card.querySelector('[data-remove-btn]');
                if (removeBtn) {
                    removeBtn.style.display = 'block';
                }

                const currentQty = productStates[product.id].quantity || 1;
                const selectedOption = card.querySelector('input[type="radio"]:checked');
                const sellingPlanId = selectedOption?.dataset.sellingPlan || null;
                const selectedVariantId = card.dataset.variantId;
                addToCart(selectedVariantId, currentQty, product, sellingPlanId);
            });
        }

        if (hasSubscription) {
            const frequencySelect = card.querySelector('[data-frequency-select]');
            frequencySelect.addEventListener('change', (e) => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                const planId = selectedOption.value;
                const planIndex = parseInt(selectedOption.dataset.planIndex);
                const plans = JSON.parse(card.dataset.sellingPlans);
                const selectedPlan = plans[planIndex];

                const subscriptionOption = card.querySelector('[data-option="subscription"]');
                const subscriptionRadio = subscriptionOption.querySelector('input');
                const subscriptionPriceWrapper = subscriptionOption.querySelector('.option-price-wrapper');

                subscriptionRadio.dataset.sellingPlan = planId;

                // Get the current variant price
                const currentVariantPrice = parseInt(card.dataset.selectedVariantPrice) || product.variants[0].price;
                const newPrice = calculateSubscriptionPrice(currentVariantPrice, selectedPlan);
                const subscriptionDiscountPercent = Math.round(((currentVariantPrice - newPrice) / currentVariantPrice) * 100);
                const subscriptionDiscountBadge = subscriptionDiscountPercent > 0 ? `<span class="product-discount-badge product-discount-badge-subscribe">SAVE ${subscriptionDiscountPercent}%</span>` : '';
                
                if (subscriptionPriceWrapper) {
                    const originalPriceEl = subscriptionPriceWrapper.querySelector('.option-price-original');
                    const originalPrice = originalPriceEl ? originalPriceEl.textContent : '';
                    subscriptionPriceWrapper.innerHTML = `
                        ${originalPrice ? `<span class="option-price-original">${originalPrice}</span>` : ''}
                        <span class="option-price">${formatMoney(newPrice)}</span>
                        ${subscriptionDiscountBadge}
                    `;
                }

                // Trigger currency converter
                updateCurrencyConverter();

                if (subscriptionRadio.checked) {
                    const currentQty = productStates[product.id].quantity || 1;
                    const selectedVariantId = parseInt(card.dataset.variantId);
                    // Only update cart if product is in cart
                    const itemInCart = cartItems.find(item => parseInt(item.variantId) === selectedVariantId);
                    if (itemInCart) {
                        const productToUpdate = itemInCart.product.selectedVariant ? itemInCart.product : product;
                        updateCartItem(selectedVariantId, currentQty, productToUpdate, planId);
                    }
                }
            });

            const purchaseOptions = card.querySelectorAll('.purchase-option');
            purchaseOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const radio = option.querySelector('input[type="radio"]');
                        radio.checked = true;
                    }

                    purchaseOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');

                    const selectedOption = card.querySelector('input[type="radio"]:checked');
                    const sellingPlanId = selectedOption.dataset.sellingPlan || null;
                    const currentQty = productStates[product.id].quantity || 1;
                    const selectedVariantId = parseInt(card.dataset.variantId);

                    console.log('Purchase option changed:', {
                        productId: product.id,
                        variantId: selectedVariantId,
                        sellingPlanId: sellingPlanId,
                        quantity: currentQty,
                        section: section
                    });

                    // Only update cart if product is in cart (check by variantId)
                    const itemInCart = cartItems.find(item => item.variantId === selectedVariantId);
                    console.log('Item in cart:', itemInCart ? 'Yes' : 'No');

                    if (itemInCart) {
                        // Create updated product with selected variant info
                        const updatedProduct = itemInCart.product.selectedVariant
                            ? itemInCart.product
                            : product;

                        // If switching to subscription on a BOGO product, remove free BOGO item first
                        if (sellingPlanId && isBogoEligible(product)) {
                            const bogoItemIndex = cartItems.findIndex(item =>
                                parseInt(item.variantId) === selectedVariantId &&
                                item.isBogoFree === true
                            );
                            if (bogoItemIndex !== -1) {
                                cartItems.splice(bogoItemIndex, 1);
                            }
                        }

                        updateCartItem(selectedVariantId, currentQty, updatedProduct, sellingPlanId);
                    }
                });
            });
        }

        return card;
    }

    function calculateSubscriptionPrice(basePrice, sellingPlan) {
        if (sellingPlan.price_adjustments && sellingPlan.price_adjustments.length > 0) {
            const adjustment = sellingPlan.price_adjustments[0];
            if (adjustment.value_type === 'percentage') {
                return basePrice * (1 - adjustment.value / 100);
            } else if (adjustment.value_type === 'fixed_amount') {
                return basePrice - adjustment.value;
            }
        }
        return basePrice;
    }

    function getDiscountPercent(sellingPlan) {
        if (sellingPlan.price_adjustments && sellingPlan.price_adjustments.length > 0) {
            const adjustment = sellingPlan.price_adjustments[0];
            if (adjustment.value_type === 'percentage') {
                return Math.round(adjustment.value);
            }
        }
        return 0;
    }

    function addToCart(variantId, quantity, product, sellingPlanId = null, isGift = false, isBogoFree = false) {
        // Ensure variantId is a number for consistent comparisons
        const numericVariantId = parseInt(variantId);
        const numericSellingPlanId = sellingPlanId ? parseInt(sellingPlanId) : null;

        const existingItemIndex = cartItems.findIndex(item =>
            parseInt(item.variantId) === numericVariantId &&
            (item.sellingPlanId ? parseInt(item.sellingPlanId) : null) === numericSellingPlanId &&
            item.isBogoFree === isBogoFree &&
            item.isGift === isGift
        );

        if (existingItemIndex !== -1) {
            cartItems[existingItemIndex].quantity = quantity;
            cartItems[existingItemIndex].product = product; // Update product reference
            cartItems[existingItemIndex].sellingPlanId = sellingPlanId; // Update selling plan
            if (quantity === 0) {
                cartItems.splice(existingItemIndex, 1);
            }
        } else if (quantity > 0) {
            cartItems.push({
                variantId: numericVariantId,
                quantity,
                product,
                sellingPlanId: sellingPlanId,
                isGift,
                isBogoFree
            });
        }

        // BOGO logic: Add free duplicate if product is BOGO eligible and it's a one-time purchase
        if (!isBogoFree && !isGift && isBogoEligible(product) && !sellingPlanId && quantity > 0) {
            // Add free BOGO item (same quantity as paid item)
            const bogoItemIndex = cartItems.findIndex(item =>
                parseInt(item.variantId) === numericVariantId &&
                item.isBogoFree === true &&
                !item.sellingPlanId
            );

            if (bogoItemIndex !== -1) {
                // Update existing BOGO item
                cartItems[bogoItemIndex].quantity = quantity;
                if (quantity === 0) {
                    cartItems.splice(bogoItemIndex, 1);
                }
            } else if (quantity > 0) {
                // Add new BOGO item
                cartItems.push({
                    variantId: numericVariantId,
                    quantity,
                    product,
                    sellingPlanId: null,
                    isGift: false,
                    isBogoFree: true
                });
            }
        }

        // If quantity is 0 and it's a paid BOGO item, also remove the free BOGO item
        if (!isBogoFree && quantity === 0 && isBogoEligible(product) && !sellingPlanId) {
            const bogoItemIndex = cartItems.findIndex(item =>
                parseInt(item.variantId) === numericVariantId &&
                item.isBogoFree === true &&
                !item.sellingPlanId
            );
            if (bogoItemIndex !== -1) {
                cartItems.splice(bogoItemIndex, 1);
            }
        }

        console.log('Cart updated. Current cart items:', cartItems.length);

        // Update tiered gift system BEFORE updating cart display (only for non-gift items)
        // This ensures gifts are added/removed before the display is rendered
        if (!isGift) {
            updateGiftTiers();
        }

        updateCartDisplay();
    }

    function removeProductFromCart(product, variantId) {
        // This function removes a product from cart AND updates the product card state
        // It's used by both the product card remove button and the cart item remove button

        console.log('=== removeProductFromCart START ===');
        console.log('Product:', product.title, 'ID:', product.id);
        console.log('Variant ID:', variantId);

        // Find the product card - try multiple selectors
        let productCard = document.querySelector(`[data-product-id="${product.id}"]`);

        // If it's a custom element, look for the actual recommended-product-card inside it
        if (productCard && productCard.tagName === 'PRODUCT-BLOCK') {
            console.log('Found PRODUCT-BLOCK, looking for recommended-product-card inside...');
            const innerCard = productCard.querySelector('.recommended-product-card');
            if (innerCard) {
                console.log('Found inner recommended-product-card');
                productCard = innerCard;
            }
        }

        console.log('Product card found:', !!productCard);

        if (productCard) {
            console.log('Product card element:', productCard);
            console.log('Product card tag:', productCard.tagName);
            console.log('Product card classes before:', productCard.className);
        }

        if (productCard && productStates[product.id]) {
            console.log('ProductState exists:', productStates[product.id]);

            // Update state
            productStates[product.id].removed = true;
            productCard.classList.add('removed');

            console.log('Product card classes after:', productCard.className);

            // Update buttons - search more deeply
            let addBtn = productCard.querySelector('[data-add-btn]');
            let removeBtn = productCard.querySelector('[data-remove-btn]');

            // If not found, search globally by product ID and button attributes
            if (!addBtn || !removeBtn) {
                console.log('Buttons not found in productCard, searching globally...');
                const allCards = document.querySelectorAll(`[data-product-id="${product.id}"]`);
                console.log('Found', allCards.length, 'elements with product ID');

                allCards.forEach((card, index) => {
                    console.log(`Card ${index}:`, card.tagName, card.className);
                    const tempAdd = card.querySelector('[data-add-btn]');
                    const tempRemove = card.querySelector('[data-remove-btn]');
                    if (tempAdd) {
                        console.log(`  - Found add button in card ${index}`);
                        addBtn = tempAdd;
                    }
                    if (tempRemove) {
                        console.log(`  - Found remove button in card ${index}`);
                        removeBtn = tempRemove;
                    }
                });
            }

            console.log('Add button found:', !!addBtn, addBtn);
            console.log('Remove button found:', !!removeBtn, removeBtn);

            if (addBtn) {
                console.log('Add button display BEFORE:', addBtn.style.display);
                addBtn.style.display = 'inline-flex';
                console.log('Add button display AFTER:', addBtn.style.display);
            }
            if (removeBtn) {
                console.log('Remove button display BEFORE:', removeBtn.style.display);
                removeBtn.style.display = 'none';
                console.log('Remove button display AFTER:', removeBtn.style.display);
            }
        } else {
            console.log('FAILED: productCard or productStates not found');
            if (!productCard) console.log('- Product card is null');
            if (!productStates[product.id]) console.log('- productStates[product.id] is null');
        }

        console.log('=== removeProductFromCart END ===');

        // Remove from cart
        updateCartItem(variantId, 0, product, null);
    }

    function updateCartItem(variantId, quantity, product, sellingPlanId = null) {
        // Ensure variantId is numeric
        const numericVariantId = parseInt(variantId);

        // Remove only non-gift, non-BOGO items with this variantId (preserve gifts and BOGO free items)
        cartItems = cartItems.filter(item =>
            parseInt(item.variantId) !== numericVariantId ||
            item.isGift ||
            item.isBogoFree
        );

        if (quantity > 0) {
            addToCart(numericVariantId, quantity, product, sellingPlanId);
        } else {
            // Update gift tiers BEFORE updating cart display when item is removed
            updateGiftTiers();
            updateCartDisplay();
        }
    }

    function updateCartDisplay() {
        const cartItemsContainer = document.querySelector('[data-cart-items]');
        const totalPriceEl = document.querySelector('[data-total-price]');
        const totalPriceHeaderEl = document.querySelector('[data-total-price-header]');
        const itemCountEl = document.querySelector('[data-item-count]');

        if (!cartItemsContainer || !totalPriceEl) return;

        cartItemsContainer.innerHTML = '';
        let subtotal = 0;
        let totalDiscount = 0;
        let itemCount = 0;

        const giftItems = [];
        const bogoItems = [];
        const onetimeItems = [];
        const subscriptionGroups = {};

        cartItems.forEach(item => {
            if (item.quantity === 0) return;

            // Don't count free BOGO items in the total count
            if (!item.isBogoFree) {
                itemCount += item.quantity;
            }

            // Get price from the correct variant using the stored variantId
            let variantPrice;
            if (item.product.selectedVariant) {
                variantPrice = item.product.selectedVariant.price;
            } else {
                // Find the variant by ID
                const variant = item.product.variants.find(v => v.id === parseInt(item.variantId));
                variantPrice = variant ? variant.price : item.product.variants[0].price;
            }

            let price = variantPrice;
            let planName = '';
            let discount = 0;

            if (item.isBogoFree) {
                bogoItems.push(item);
            } else if (item.isGift) {
                giftItems.push(item);
            } else if (item.sellingPlanId && item.product.selling_plan_groups) {
                const sellingPlanGroup = item.product.selling_plan_groups[0];
                const sellingPlan = sellingPlanGroup.selling_plans.find(sp => sp.id == item.sellingPlanId);
                if (sellingPlan) {
                    const originalPrice = variantPrice;
                    price = calculateSubscriptionPrice(variantPrice, sellingPlan);
                    planName = sellingPlan.name;
                    discount = getDiscountPercent(sellingPlan);

                    if (!subscriptionGroups[planName]) {
                        subscriptionGroups[planName] = [];
                    }
                    subscriptionGroups[planName].push({
                        item,
                        price,
                        originalPrice,
                        discount
                    });

                    subtotal += originalPrice * item.quantity;
                    totalDiscount += (originalPrice - price) * item.quantity;
                }
            } else {
                onetimeItems.push(item);
                subtotal += price * item.quantity;
            }
        });

        // Render unlocked gift tiers (visual only - not in cartItems)
        if (giftTiersEnabled && giftTiers.length > 0) {
            giftTiers.forEach(tier => {
                if (!tier.unlocked || !tier.product) return;

                const variant = tier.variantId ? tier.product.variants.find(v => v.id === tier.variantId) : tier.product.variants[0];
                const variantTitle = variant && variant.title !== 'Default Title' ? ` - ${variant.title}` : '';
                const variantPrice = variant ? variant.price : tier.product.variants[0].price;
                const formattedOriginalPrice = formatMoney(variantPrice);

                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item cart-gift-item';
                cartItem.dataset.giftTier = tier.tier;
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <span class="cart-item-name">${tier.product.title}${variantTitle}</span>
                        <div class="cart-item-meta">Free Gift</div>
                    </div>
                    <div class="cart-item-price cart-gift-price">
                        <span class="cart-gift-original-price">${formattedOriginalPrice}</span>
                        <strong class="cart-gift-free-price">FREE</strong>
                    </div>
                `;
                cartItemsContainer.appendChild(cartItem);
            });
        }

        // Legacy gift items from cartItems (for old single gift system)
        giftItems.forEach(item => {
            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.dataset.variantId = item.variantId;
            cartItem.dataset.sellingPlanId = item.sellingPlanId || '';
            // Include variant title if available
            const variantTitle = item.variantTitle ? ` - ${item.variantTitle}` : '';
            cartItem.innerHTML = `
                <div class="cart-item-info">
                    <span class="cart-item-name">${item.product.title}${variantTitle}</span>
                    <div class="cart-item-meta">Free Gift</div>
                </div>
                <div class="cart-item-price"><strong>FREE</strong></div>
            `;
            cartItemsContainer.appendChild(cartItem);
        });

        Object.keys(subscriptionGroups).forEach(planName => {
            const group = subscriptionGroups[planName];

            const groupHeader = document.createElement('div');
            groupHeader.className = 'cart-subscription-group-header';
            groupHeader.innerHTML = `Ships ${planName.toLowerCase()}`;
            cartItemsContainer.appendChild(groupHeader);

            group.forEach(({ item, price, originalPrice, discount }) => {
                const itemTotal = price * item.quantity;
                const originalTotal = originalPrice * item.quantity;
                const hasSubscriptionDiscount = itemTotal < originalTotal;

                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item cart-subscription-item';
                cartItem.dataset.variantId = item.variantId;
                cartItem.dataset.sellingPlanId = item.sellingPlanId || '';

                // Get variant title and compare_at_price if there are multiple variants
                let productName = item.product.title;
                let variant = null;
                if (item.product.variants.length > 1) {
                    variant = item.product.variants.find(v => v.id === parseInt(item.variantId));
                    if (variant && variant.title !== 'Default Title') {
                        productName += ` - ${variant.title}`;
                    }
                } else {
                    variant = item.product.variants[0];
                }

                // Check for compare_at_price (product discount)
                const hasCompareAtPrice = variant && variant.compare_at_price && variant.compare_at_price > originalPrice;
                const compareAtTotal = hasCompareAtPrice ? variant.compare_at_price * item.quantity : null;

                let priceHTML = '';
                if (hasCompareAtPrice) {
                    // Product has compare_at_price, show: compare_at crossed out, then either original or discounted subscription price
                    if (hasSubscriptionDiscount) {
                        priceHTML = `
                            <div class="cart-item-price">
                                <span class="cart-item-price-original">${formatMoney(compareAtTotal)}</span>
                                <span class="cart-item-price-discounted">${formatMoney(itemTotal)}</span>
                            </div>
                        `;
                    } else {
                        priceHTML = `
                            <div class="cart-item-price">
                                <span class="cart-item-price-original">${formatMoney(compareAtTotal)}</span>
                                <span class="cart-item-price-discounted">${formatMoney(itemTotal)}</span>
                            </div>
                        `;
                    }
                } else if (hasSubscriptionDiscount) {
                    // No compare_at_price, but has subscription discount
                    priceHTML = `
                        <div class="cart-item-price">
                            <span class="cart-item-price-original">${formatMoney(originalTotal)}</span>
                            <span class="cart-item-price-discounted">${formatMoney(itemTotal)}</span>
                        </div>
                    `;
                } else {
                    priceHTML = `<div class="cart-item-price">${formatMoney(itemTotal)}</div>`;
                }

                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <span class="cart-item-name">[${item.quantity}] ${productName}</span>
                    </div>
                    ${priceHTML}
                    <button class="cart-item-remove" data-cart-remove aria-label="Remove item">×</button>
                `;
                cartItemsContainer.appendChild(cartItem);
            });
        });

        onetimeItems.forEach(item => {
            // Get price and variant from the correct variant using the stored variantId
            let variant;
            let variantPrice;
            if (item.product.selectedVariant) {
                variant = item.product.selectedVariant;
                variantPrice = variant.price;
            } else {
                // Find the variant by ID
                variant = item.product.variants.find(v => v.id === parseInt(item.variantId));
                if (!variant) {
                    variant = item.product.variants[0];
                }
                variantPrice = variant.price;
            }
            const price = variantPrice;
            const itemTotal = price * item.quantity;

            // Check for compare_at_price (product discount)
            const hasCompareAtPrice = variant && variant.compare_at_price && variant.compare_at_price > price;
            const compareAtTotal = hasCompareAtPrice ? variant.compare_at_price * item.quantity : null;

            // Get variant title if there are multiple variants
            let productName = item.product.title;
            if (item.product.variants.length > 1 && variant.title !== 'Default Title') {
                productName += ` - ${variant.title}`;
            }

            // Determine price HTML
            let priceHTML = '';
            if (hasCompareAtPrice) {
                priceHTML = `
                    <div class="cart-item-price">
                        <span class="cart-item-price-original">${formatMoney(compareAtTotal)}</span>
                        <span class="cart-item-price-discounted">${formatMoney(itemTotal)}</span>
                    </div>
                `;
            } else {
                priceHTML = `<div class="cart-item-price">${formatMoney(itemTotal)}</div>`;
            }

            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.dataset.variantId = item.variantId;
            cartItem.dataset.sellingPlanId = item.sellingPlanId || '';
            cartItem.innerHTML = `
                <div class="cart-item-info">
                    <span class="cart-item-name">[${item.quantity}] ${productName}</span>
                </div>
                ${priceHTML}
                <button class="cart-item-remove" data-cart-remove aria-label="Remove item">×</button>
            `;
            cartItemsContainer.appendChild(cartItem);

            // Check if this item has a matching BOGO free item and render it right after
            const matchingBogoItem = bogoItems.find(bogoItem =>
                parseInt(bogoItem.variantId) === parseInt(item.variantId)
            );

            if (matchingBogoItem) {
                let bogoProductName = matchingBogoItem.product.title;
                if (matchingBogoItem.product.variants.length > 1) {
                    const bogoVariant = matchingBogoItem.product.variants.find(v => v.id === parseInt(matchingBogoItem.variantId));
                    if (bogoVariant && bogoVariant.title !== 'Default Title') {
                        bogoProductName += ` - ${bogoVariant.title}`;
                    }
                }

                const bogoCartItem = document.createElement('div');
                bogoCartItem.className = 'cart-item cart-item-bogo';
                bogoCartItem.dataset.variantId = matchingBogoItem.variantId;
                bogoCartItem.dataset.sellingPlanId = matchingBogoItem.sellingPlanId || '';
                bogoCartItem.innerHTML = `
                    <div class="cart-item-info">
                        <span class="cart-item-name">[${matchingBogoItem.quantity}] ${bogoProductName}</span>
                        <span class="cart-item-bogo-label">${bogoCartText}</span>
                    </div>
                    <div class="cart-item-price"><strong>FREE</strong></div>
                `;
                cartItemsContainer.appendChild(bogoCartItem);
            }
        });

        const divider = document.createElement('div');
        divider.className = 'cart-summary-divider';
        cartItemsContainer.appendChild(divider);

        const subtotalRow = document.createElement('div');
        subtotalRow.className = 'cart-summary-row';
        subtotalRow.innerHTML = `
            <span>Subtotal:</span>
            <span>${formatMoney(subtotal)}</span>
        `;
        cartItemsContainer.appendChild(subtotalRow);

        if (totalDiscount > 0) {
            const discountRow = document.createElement('div');
            discountRow.className = 'cart-summary-row';
            discountRow.innerHTML = `
                <span>Discount:</span>
                <span>-${formatMoney(totalDiscount)}</span>
            `;
            cartItemsContainer.appendChild(discountRow);
        }

        const vatRow = document.createElement('div');
        vatRow.className = 'cart-summary-row';
        vatRow.innerHTML = `
            <span>VAT:</span>
            <span>Calculated at checkout</span>
        `;
        cartItemsContainer.appendChild(vatRow);

        const shippingRow = document.createElement('div');
        shippingRow.className = 'cart-summary-row';
        shippingRow.innerHTML = `
            <span>Shipping:</span>
            <span style="font-weight: bold;">Free</span>
        `;
        cartItemsContainer.appendChild(shippingRow);

        const total = subtotal - totalDiscount;
        const totalRow = document.createElement('div');
        totalRow.className = 'cart-summary-row total';
        totalRow.innerHTML = `
            <span>Total:</span>
            <span>${formatMoney(total)}</span>
        `;
        cartItemsContainer.appendChild(totalRow);

        const totalFormatted = formatMoney(total);
        totalPriceEl.innerHTML = totalFormatted;

        if (totalPriceHeaderEl) {
            totalPriceHeaderEl.innerHTML = totalFormatted;
        }

        if (itemCountEl) {
            itemCountEl.textContent = `(${itemCount})`;
        }

        // Update mobile sticky bar
        const mobileOriginalPriceEl = document.querySelector('[data-mobile-original-price]');
        const mobileTotalPriceEl = document.querySelector('[data-mobile-total-price]');
        if (mobileOriginalPriceEl) {
            // Show original subtotal (before discounts)
            mobileOriginalPriceEl.textContent = formatMoney(subtotal);
        }
        if (mobileTotalPriceEl) {
            // Show final total (after discounts)
            mobileTotalPriceEl.textContent = totalFormatted;
        }

        // Add click handlers for cart item remove buttons
        const removeButtons = cartItemsContainer.querySelectorAll('[data-cart-remove]');
        removeButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const cartItemEl = button.closest('.cart-item');
                const variantId = parseInt(cartItemEl.dataset.variantId);

                // Find the cart item to get the product reference
                const cartItem = cartItems.find(item => parseInt(item.variantId) === variantId);
                if (cartItem && !cartItem.isGift) {
                    // Use the same function as the product card remove button
                    removeProductFromCart(cartItem.product, variantId);
                } else if (cartItem && cartItem.isGift) {
                    // For gift items, just remove from cart (no product card to update)
                    updateCartItem(variantId, 0, cartItem.product, null);
                }
            });
        });

        // Trigger currency converter to update all new prices
        setTimeout(() => {
            updateCurrencyConverter();
        }, 100);
    }

    const cartToggle = document.querySelector('[data-cart-toggle]');
    const cartClose = document.querySelector('[data-cart-close]');
    const cartSummary = document.querySelector('.cart-summary');
    const cartHeader = document.querySelector('[data-cart-header]');
    const mobileCartColumn = document.querySelector('.quiz-recommendations-cart-column');
    const mobileStickyBar = document.querySelector('.quiz-recommendations-mobile-sticky-bar');
    const mobilePriceToggle = document.querySelector('[data-mobile-price-toggle]');
    const mobileCheckoutBtn = document.querySelector('[data-mobile-checkout-btn]');

    function initCartState() {
        // Desktop: cart is always visible
        // Mobile: cart column is hidden by default, shown when sticky bar is clicked
        if (window.innerWidth <= 1024 && mobileCartColumn) {
            mobileCartColumn.classList.remove('mobile-expanded');
        }
    }


    if (cartToggle && cartSummary) {
        initCartState();

        window.addEventListener('resize', () => {
            if (window.innerWidth <= 1024) {
                if (mobileCartColumn && mobileCartColumn.classList.contains('mobile-expanded')) {
                    mobileCartColumn.classList.remove('mobile-expanded');
                }
            }
        });

        cartToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            cartSummary.classList.toggle('collapsed');
        });

        if (cartHeader) {
            cartHeader.addEventListener('click', () => {
                cartSummary.classList.toggle('collapsed');
            });
        }

        if (cartClose) {
            cartClose.addEventListener('click', () => {
                cartSummary.classList.add('collapsed');
                if (mobileCartColumn) {
                    mobileCartColumn.classList.remove('mobile-expanded');
                }
            });
        }
    }

    // Mobile sticky bar price dropdown toggle
    if (mobilePriceToggle) {
        mobilePriceToggle.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            mobilePriceToggle.classList.toggle('expanded');
            // Toggle cart column visibility
            if (mobileCartColumn) {
                mobileCartColumn.classList.toggle('mobile-expanded');
            }
        });
    }

    // Mobile checkout button
    if (mobileCheckoutBtn) {
        mobileCheckoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            checkout();
        });
    }

    // Countdown Timer
    function initCountdownTimer() {
        const timerEl = document.querySelector('[data-countdown-timer]');
        if (!timerEl) return;

        const hoursEl = timerEl.querySelector('[data-timer-hours]');
        const minutesEl = timerEl.querySelector('[data-timer-minutes]');
        const secondsEl = timerEl.querySelector('[data-timer-seconds]');
        const millisecondsEl = timerEl.querySelector('[data-timer-milliseconds]');

        if (!hoursEl || !minutesEl || !secondsEl || !millisecondsEl) return;

        const recommendationsSectionForCountdown = document.querySelector('[data-recommendations]');
        const hours = parseInt(recommendationsSectionForCountdown?.dataset.countdownHours || '0') || 0;
        const minutes = parseInt(recommendationsSectionForCountdown?.dataset.countdownMinutes || '9') || 9;
        const seconds = parseInt(recommendationsSectionForCountdown?.dataset.countdownSeconds || '57') || 57;

        let totalMilliseconds = (hours * 3600 + minutes * 60 + seconds) * 1000;

        function updateTimer() {
            if (totalMilliseconds <= 0) {
                hoursEl.textContent = '00';
                minutesEl.textContent = '00';
                secondsEl.textContent = '00';
                millisecondsEl.textContent = '00';
                return;
            }

            const h = Math.floor(totalMilliseconds / 3600000);
            const m = Math.floor((totalMilliseconds % 3600000) / 60000);
            const s = Math.floor((totalMilliseconds % 60000) / 1000);
            const ms = Math.floor((totalMilliseconds % 1000) / 10);

            hoursEl.textContent = String(h).padStart(2, '0');
            minutesEl.textContent = String(m).padStart(2, '0');
            secondsEl.textContent = String(s).padStart(2, '0');
            millisecondsEl.textContent = String(ms).padStart(2, '0');

            totalMilliseconds -= 100;
        }

        updateTimer();
        const timerInterval = setInterval(() => {
            updateTimer();
            if (totalMilliseconds <= 0) {
                clearInterval(timerInterval);
            }
        }, 100);
    }

    // Upsell Button Handler
    function initUpsellButton() {
        const upsellButton = document.querySelector('[data-upsell-button]');
        if (!upsellButton) return;

        upsellButton.addEventListener('click', async (e) => {
            e.preventDefault();
            const productHandle = upsellButton.dataset.productHandle;
            if (!productHandle) return;

            try {
                const productResponse = await fetch(`/products/${productHandle}.js`);
                const product = await productResponse.json();
                
                if (product && product.variants && product.variants.length > 0) {
                    const variantId = product.variants[0].id;
                    addToCart(variantId, 1, product, null);
                    
                    // Scroll to top of products
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
            } catch (err) {
                console.error('Error adding upsell product:', err);
            }
        });
    }

    // Initialize countdown and upsell when recommendations are shown
    const recommendationsSectionForTimer = document.querySelector('[data-recommendations]');
    if (recommendationsSectionForTimer) {
        const timerObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === 'style') {
                    if (recommendationsSectionForTimer.style.display !== 'none') {
                        initCountdownTimer();
                        initUpsellButton();
                    }
                }
            });
        });
        timerObserver.observe(recommendationsSectionForTimer, { attributes: true });
    }


    async function checkout() {
        if (cartItems.length === 0) {
            alert('Please select at least one product');
            return;
        }

        const checkoutBtns = document.querySelectorAll('[data-checkout-btn]');
        checkoutBtns.forEach(btn => {
            btn.classList.add('loading');
            btn.textContent = 'Processing...';
        });

        try {
            const cartResponse = await fetch('/cart.js');
            const currentCart = await cartResponse.json();

            const clearResponse = await fetch('/cart/clear.js', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!clearResponse.ok) throw new Error('Failed to clear cart');

            await new Promise(resolve => setTimeout(resolve, 500));

            // Track BOGO items to avoid duplicates and double quantities
            const processedVariants = new Set();
            const bogoItems = [];

            for (const item of cartItems.filter(item => item.quantity > 0)) {
                // Skip free BOGO items - they'll be handled by doubling the paid item quantity
                if (item.isBogoFree) {
                    continue;
                }

                let finalQuantity = item.quantity;

                // Check if this item has a matching free BOGO item
                const hasBogoFreeItem = cartItems.some(cartItem =>
                    parseInt(cartItem.variantId) === parseInt(item.variantId) &&
                    cartItem.isBogoFree === true &&
                    !cartItem.sellingPlanId
                );

                if (hasBogoFreeItem && !item.sellingPlanId) {
                    // Double the quantity for BOGO items (buy 1 get 1 = 2x quantity)
                    finalQuantity = item.quantity * 2;
                    bogoItems.push(item.product.title);
                }

                const itemData = {
                    id: item.variantId,
                    quantity: finalQuantity
                };

                if (item.sellingPlanId) {
                    itemData.selling_plan = item.sellingPlanId;
                }

                const addResponse = await fetch('/cart/add.js', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: [itemData] })
                });

                if (!addResponse.ok) {
                    const errorText = await addResponse.text();
                    console.error(`Failed to add item ${item.variantId}:`, errorText);
                    throw new Error(`Failed to add item ${item.variantId}`);
                }

                await new Promise(resolve => setTimeout(resolve, 200));
            }

            // Helper function to sanitize text for order notes
            // Removes/replaces problematic characters that can cause issues with Shopify's API
            function sanitizeForOrderNote(text) {
                if (text === null || text === undefined) return '';
                return String(text)
                    .replace(/[\u0000-\u001F\u007F-\u009F]/g, '') // Remove control characters
                    .replace(/[""]/g, '"') // Normalize smart quotes
                    .replace(/['']/g, "'") // Normalize smart apostrophes
                    .replace(/[—–]/g, '-') // Normalize dashes
                    .replace(/…/g, '...') // Normalize ellipsis
                    .trim();
            }

            let orderNote = '--- QUIZ RESULTS ---\n';

            // Add BOGO information to order note
            if (bogoItems.length > 0) {
                orderNote += '\nBOGO PROMOTION:\n';
                orderNote += 'The following products had Buy 1 Get 1 Free applied:\n';
                bogoItems.forEach(productTitle => {
                    orderNote += `- ${sanitizeForOrderNote(productTitle)}\n`;
                });
                orderNote += '(Quantities have been doubled in the cart)\n';
            }

            if (window.QuizManager) {
                const qm = window.QuizManager;

                if (qm.introData && Object.keys(qm.introData).length > 0) {
                    orderNote += '\nINTRO DATA:\n';
                    Object.keys(qm.introData).forEach(key => {
                        const value = sanitizeForOrderNote(qm.introData[key]);
                        if (value) {
                            orderNote += `${sanitizeForOrderNote(key)}: ${value}\n`;
                        }
                    });
                }

                if (qm.calculatedPorosity || qm.calculatedElasticity) {
                    orderNote += '\nCALCULATED VALUES:\n';
                    if (qm.calculatedPorosity) {
                        orderNote += `Porosity: ${sanitizeForOrderNote(qm.calculatedPorosity)}\n`;
                    }
                    if (qm.calculatedElasticity) {
                        orderNote += `Elasticity: ${sanitizeForOrderNote(qm.calculatedElasticity)}\n`;
                    }
                }

                if (qm.formulationHairTreatment || qm.formulationElixir || qm.formulationConditioner) {
                    orderNote += '\nFORMULATION VALUES:\n';
                    if (qm.formulationHairTreatment) {
                        orderNote += `Hair Treatment: ${sanitizeForOrderNote(qm.formulationHairTreatment)}\n`;
                    }
                    if (qm.formulationElixir) {
                        orderNote += `Elixir: ${sanitizeForOrderNote(qm.formulationElixir)}\n`;
                    }
                    if (qm.formulationConditioner) {
                        orderNote += `Conditioner: ${sanitizeForOrderNote(qm.formulationConditioner)}\n`;
                    }
                }

                if (qm.answers && Object.keys(qm.answers).length > 0) {
                    orderNote += '\nQUIZ ANSWERS:\n';

                    // Sort questions by orderNotePosition (same positions keep natural order)
                    const sortedQuestionIds = Object.keys(qm.answers).sort((a, b) => {
                        const answerA = qm.answers[a];
                        const answerB = qm.answers[b];
                        const posA = Array.isArray(answerA) ? answerA.orderNotePosition : answerA.orderNotePosition;
                        const posB = Array.isArray(answerB) ? answerB.orderNotePosition : answerB.orderNotePosition;

                        // Default to 10 if not set
                        const valA = (posA === null || posA === undefined) ? 10 : posA;
                        const valB = (posB === null || posB === undefined) ? 10 : posB;

                        return valA - valB;
                    });

                    sortedQuestionIds.forEach(questionId => {
                        const answer = qm.answers[questionId];
                        let answerText = '';

                        if (answer.type === 'free_text') {
                            answerText = sanitizeForOrderNote(answer.title);
                        } else if (Array.isArray(answer)) {
                            answerText = answer.map(a => sanitizeForOrderNote(a.title)).filter(t => t).join(', ');
                        } else {
                            answerText = sanitizeForOrderNote(answer.title);
                        }

                        // Only add if we have actual content
                        if (answerText) {
                            orderNote += `${sanitizeForOrderNote(questionId)}: ${answerText}\n`;

                            if (Array.isArray(answer)) {
                                answer.forEach((a, idx) => {
                                    if (a.formulations && a.formulations.length > 0) {
                                        orderNote += `  - Formulations: ${a.formulations.join(', ')}\n`;
                                    }
                                });
                            } else if (answer.formulations && answer.formulations.length > 0) {
                                orderNote += `  - Formulations: ${answer.formulations.join(', ')}\n`;
                            }
                        }
                    });
                }
            }

            orderNote += '\n--- END QUIZ RESULTS ---';

            // Shopify has a 5000 character limit for cart notes
            // Truncate if necessary to prevent silent failures
            const MAX_NOTE_LENGTH = 4900; // Leave some buffer
            if (orderNote.length > MAX_NOTE_LENGTH) {
                console.warn(`Order note exceeded ${MAX_NOTE_LENGTH} chars (${orderNote.length}), truncating...`);
                orderNote = orderNote.substring(0, MAX_NOTE_LENGTH) + '\n\n[Note truncated due to length]';
            }

            const updateResponse = await fetch('/cart/update.js', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ note: orderNote })
            });

            if (!updateResponse.ok) throw new Error('Failed to update cart note');

            window.location.href = '/checkout';

        } catch (err) {
            console.error('Error during checkout:', err);
            checkoutBtns.forEach(btn => {
                btn.classList.remove('loading');
                btn.textContent = 'Checkout';
            });
            alert('There was an error processing your order. Please try again.');
        }
    }

    const checkoutBtns = document.querySelectorAll('[data-checkout-btn]');
    checkoutBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            checkout();
        });
    });

    // Make initRecommendations globally accessible
    window.initRecommendations = initRecommendations;

    // Initialize recommendations when section becomes visible
    // Use the same variable from the countdown timer section above
    if (recommendationsSectionForTimer) {
        // Check if section is already visible
        const checkVisibility = () => {
            const style = window.getComputedStyle(recommendationsSectionForTimer);
            const isVisible = recommendationsSectionForTimer.style.display !== 'none' && 
                             style.display !== 'none' &&
                             recommendationsSectionForTimer.offsetParent !== null;
            
            console.log('Checking visibility:', {
                inlineStyle: recommendationsSectionForTimer.style.display,
                computedStyle: style.display,
                offsetParent: recommendationsSectionForTimer.offsetParent !== null,
                isVisible: isVisible,
                initialized: initialized
            });
            
            if (isVisible && !initialized) {
                console.log('Recommendations section is visible, initializing...');
                // Wait a bit to ensure QuizManager is ready
                setTimeout(() => {
                    initRecommendations();
                }, 200);
            }
        };

        // Listen for custom event from quiz-result section
        document.addEventListener('recommendations-visible', function() {
            console.log('Recommendations visible event received');
            setTimeout(() => {
                checkVisibility();
            }, 100);
        });

        // MutationObserver for style changes
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.attributeName === 'style' || mutation.attributeName === 'class') {
                    console.log('Style/class changed:', mutation.attributeName);
                    checkVisibility();
                }
            });
        });
        observer.observe(recommendationsSectionForTimer, { 
            attributes: true, 
            attributeFilter: ['style', 'class'],
            childList: false,
            subtree: false
        });

        // Also check on DOM ready and periodically
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                checkVisibility();
                // Also check periodically in case QuizManager loads later
                const checkInterval = setInterval(() => {
                    if (initialized) {
                        clearInterval(checkInterval);
                        return;
                    }
                    checkVisibility();
                }, 500);
                // Stop checking after 10 seconds
                setTimeout(() => clearInterval(checkInterval), 10000);
            });
        } else {
            checkVisibility();
            // Also check periodically
            const checkInterval = setInterval(() => {
                if (initialized) {
                    clearInterval(checkInterval);
                    return;
                }
                checkVisibility();
            }, 500);
            setTimeout(() => clearInterval(checkInterval), 10000);
        }
    } else {
        console.error('Recommendations section not found in DOM');
    }
})();
</script>

{% schema %}
{
    "name": "Quiz Recommendations",
    "class": "quiz-section",
    "settings": [
        {
            "type": "header",
            "content": "Header Section"
        },
        {
            "type": "checkbox",
            "id": "show_feature_bar",
            "label": "Show Feature Bar",
            "default": true
        },
        {
            "type": "text",
            "id": "sale_banner_text",
            "label": "Sale Banner Text",
            "default": "WINTER SALE 25% OFF SITEWIDE!"
        },
        {
            "type": "richtext",
            "id": "intro_text",
            "label": "Introductory Text",
            "default": "<p>Your hair story is about to change. These products were chosen to help you grow, heal, and fall in love with your hair again. They're already waiting in your basket. All that's left is to begin.</p>"
        },
        {
            "type": "text",
            "id": "cta_button_text",
            "label": "CTA Button Text",
            "default": "Your Top 3 Products +25% OFF"
        },
        {
            "type": "header",
            "content": "Product Order"
        },
        {
            "type": "product_list",
            "id": "product_sort_order",
            "label": "Custom Product Order (Optional)",
            "info": "Set the display order of recommended products. Only products that were recommended by the quiz will be shown, in the order specified here. Leave empty to use default quiz order.",
            "limit": 20
        },
        {
            "type": "header",
            "content": "Section 1: Top Picks"
        },
        {
            "type": "text",
            "id": "section1_title",
            "label": "Section 1 Title",
            "default": "Our Top 3 Picks For You"
        },
        {
            "type": "richtext",
            "id": "section1_description",
            "label": "Section 1 Description",
            "info": "First 3 quiz recommendations, auto-added to cart"
        },
        {
            "type": "header",
            "content": "Section 2: Additional Recommendations"
        },
        {
            "type": "text",
            "id": "section2_title",
            "label": "Section 2 Title",
            "default": "Transform your routine into a ritual"
        },
        {
            "type": "richtext",
            "id": "section2_description",
            "label": "Section 2 Description",
            "info": "Remaining quiz recommendations, not auto-added to cart"
        },
        {
            "type": "header",
            "content": "Section 3: Accessories"
        },
        {
            "type": "text",
            "id": "section3_title",
            "label": "Section 3 Title",
            "default": "Hair Accessories You didn't know Your Hair Needed"
        },
        {
            "type": "richtext",
            "id": "section3_description",
            "label": "Section 3 Description",
            "info": "Manual product selection, not auto-added to cart"
        },
        {
            "type": "product_list",
            "id": "accessories_products",
            "label": "Accessory Products",
            "info": "Select products to display in the accessories section"
        },
        {
            "type": "header",
            "content": "Tiered Gift System"
        },
        {
            "type": "checkbox",
            "id": "gift_tiers_enabled",
            "label": "Enable Tiered Gifts",
            "default": false,
            "info": "Enable to show tiered free gifts based on cart total"
        },
        {
            "type": "text",
            "id": "gift_progress_text",
            "label": "Progress Bar Text",
            "default": "Spend [[remaining]] more to unlock your next gift!",
            "info": "Use [[remaining]] for amount needed, [[current]] for current total, [[next_tier]] for next tier threshold"
        },
        {
            "type": "text",
            "id": "gift_complete_text",
            "label": "All Tiers Complete Text",
            "default": "You've unlocked all free gifts!",
            "info": "Shown when all gift tiers have been reached"
        },
        {
            "type": "color",
            "id": "gift_progress_bar_color",
            "label": "Progress Bar Color",
            "default": "#d4ff6a"
        },
        {
            "type": "color",
            "id": "gift_progress_bar_bg_color",
            "label": "Progress Bar Background Color",
            "default": "#e5e7eb"
        },
        {
            "type": "color",
            "id": "gift_milestone_color",
            "label": "Milestone Reached Color",
            "default": "#d4ff6a"
        },
        {
            "type": "header",
            "content": "Tier 1 Gift"
        },
        {
            "type": "number",
            "id": "tier1_threshold",
            "label": "Tier 1 - Minimum Cart Total",
            "default": 100,
            "info": "Cart total (in base currency, e.g. EUR) needed to unlock Tier 1 gift"
        },
        {
            "type": "product",
            "id": "tier1_gift_female",
            "label": "Tier 1 - Gift Product (Female)"
        },
        {
            "type": "text",
            "id": "tier1_variant_female",
            "label": "Tier 1 - Variant ID (Female)",
            "info": "Optional: Enter the variant ID to use a specific variant. Leave empty for default variant."
        },
        {
            "type": "product",
            "id": "tier1_gift_male",
            "label": "Tier 1 - Gift Product (Male)"
        },
        {
            "type": "text",
            "id": "tier1_variant_male",
            "label": "Tier 1 - Variant ID (Male)",
            "info": "Optional: Enter the variant ID to use a specific variant. Leave empty for default variant."
        },
        {
            "type": "text",
            "id": "tier1_banner_text",
            "label": "Tier 1 - Banner Text",
            "default": "FREE GIFT UNLOCKED!"
        },
        {
            "type": "textarea",
            "id": "tier1_description",
            "label": "Tier 1 - Gift Description",
            "default": "Complimentary with your purchase"
        },
        {
            "type": "header",
            "content": "Tier 2 Gift"
        },
        {
            "type": "number",
            "id": "tier2_threshold",
            "label": "Tier 2 - Minimum Cart Total",
            "default": 150,
            "info": "Cart total (in base currency, e.g. EUR) needed to unlock Tier 2 gift (set to 0 to disable)"
        },
        {
            "type": "product",
            "id": "tier2_gift_female",
            "label": "Tier 2 - Gift Product (Female)"
        },
        {
            "type": "text",
            "id": "tier2_variant_female",
            "label": "Tier 2 - Variant ID (Female)",
            "info": "Optional: Enter the variant ID to use a specific variant. Leave empty for default variant."
        },
        {
            "type": "product",
            "id": "tier2_gift_male",
            "label": "Tier 2 - Gift Product (Male)"
        },
        {
            "type": "text",
            "id": "tier2_variant_male",
            "label": "Tier 2 - Variant ID (Male)",
            "info": "Optional: Enter the variant ID to use a specific variant. Leave empty for default variant."
        },
        {
            "type": "text",
            "id": "tier2_banner_text",
            "label": "Tier 2 - Banner Text",
            "default": "BONUS GIFT UNLOCKED!"
        },
        {
            "type": "textarea",
            "id": "tier2_description",
            "label": "Tier 2 - Gift Description",
            "default": "Extra reward for your order"
        },
        {
            "type": "header",
            "content": "Tier 3 Gift"
        },
        {
            "type": "number",
            "id": "tier3_threshold",
            "label": "Tier 3 - Minimum Cart Total",
            "default": 200,
            "info": "Cart total (in base currency, e.g. EUR) needed to unlock Tier 3 gift (set to 0 to disable)"
        },
        {
            "type": "product",
            "id": "tier3_gift_female",
            "label": "Tier 3 - Gift Product (Female)"
        },
        {
            "type": "text",
            "id": "tier3_variant_female",
            "label": "Tier 3 - Variant ID (Female)",
            "info": "Optional: Enter the variant ID to use a specific variant. Leave empty for default variant."
        },
        {
            "type": "product",
            "id": "tier3_gift_male",
            "label": "Tier 3 - Gift Product (Male)"
        },
        {
            "type": "text",
            "id": "tier3_variant_male",
            "label": "Tier 3 - Variant ID (Male)",
            "info": "Optional: Enter the variant ID to use a specific variant. Leave empty for default variant."
        },
        {
            "type": "text",
            "id": "tier3_banner_text",
            "label": "Tier 3 - Banner Text",
            "default": "VIP GIFT UNLOCKED!"
        },
        {
            "type": "textarea",
            "id": "tier3_description",
            "label": "Tier 3 - Gift Description",
            "default": "Thank you for your loyalty"
        },
        {
            "type": "header",
            "content": "Legacy Gift Product (deprecated)"
        },
        {
            "type": "product",
            "id": "gift_product",
            "label": "Gift Product (optional)",
            "info": "Deprecated - use Tiered Gift System above instead"
        },
        {
            "type": "text",
            "id": "gift_banner_text",
            "label": "Gift Banner Text",
            "default": "FREE GIFT ADDED TO YOUR CART",
            "info": "Text shown in the top bar of the gift product card"
        },
        {
            "type": "textarea",
            "id": "gift_description",
            "label": "Gift Description",
            "default": "Complimentary with your purchase"
        },
        {
            "type": "header",
            "content": "Black Friday BOGO Promo"
        },
        {
            "type": "checkbox",
            "id": "bogo_enabled",
            "label": "Enable BOGO Promo",
            "default": false,
            "info": "Turn on/off the Buy One Get One Free promotion"
        },
        {
            "type": "product_list",
            "id": "bogo_products",
            "label": "BOGO Eligible Products",
            "info": "Select products that are eligible for Buy One Get One Free (one-time purchases only, not subscriptions)",
            "limit": 20
        },
        {
            "type": "text",
            "id": "bogo_badge_text",
            "label": "BOGO Badge Text",
            "default": "BUY 1 GET 1 FREE",
            "info": "Text shown on product card badges"
        },
        {
            "type": "text",
            "id": "bogo_cart_text",
            "label": "BOGO Cart Text",
            "default": "Buy 1 Get 1 Free",
            "info": "Text shown in cart for BOGO items"
        },
        {
            "type": "header",
            "content": "Colors"
        },
        {
            "type": "color",
            "id": "primary_color",
            "label": "Primary Color",
            "default": "#000000"
        },
        {
            "type": "color",
            "id": "text_color",
            "label": "Text Color",
            "default": "#111827"
        },
        {
            "type": "color",
            "id": "highlight_color",
            "label": "Highlight Color",
            "default": "#d4ff6a",
            "info": "Used for gift banner and highlight boxes"
        },
        {
            "type": "color",
            "id": "button_color",
            "label": "Button Background Color",
            "default": "#000000"
        },
        {
            "type": "color",
            "id": "button_text_color",
            "label": "Button Text Color",
            "default": "#ffffff"
        },
        {
            "type": "text",
            "id": "button_border_radius",
            "label": "Button Border Radius",
            "default": "5rem",
            "info": "CSS value for button border radius (e.g., 5rem, 8px, 50%)"
        },
        {
            "type": "color",
            "id": "remove_button_color",
            "label": "Remove Button Background Color",
            "default": "#ef4444"
        },
        {
            "type": "color",
            "id": "remove_button_text_color",
            "label": "Remove Button Text Color",
            "default": "#ffffff"
        },
        {
            "type": "color",
            "id": "checkout_button_color",
            "label": "Checkout Button Background Color",
            "default": "#22c55e",
            "info": "Background color for the checkout button"
        },
        {
            "type": "color",
            "id": "checkout_button_text_color",
            "label": "Checkout Button Text Color",
            "default": "#ffffff",
            "info": "Text color for the checkout button"
        },
        {
            "type": "color",
            "id": "background_color",
            "label": "Background Color",
            "default": "#f0f0ff"
        },
        {
            "type": "header",
            "content": "Highlight Text Boxes"
        },
        {
            "type": "richtext",
            "id": "highlight_text_desktop",
            "label": "Highlight Text (Desktop)",
            "info": "Appears in cart summary on desktop. Use [[amount:100]] for auto-converted currency (e.g., '[[amount:100]]' becomes '$180' in USD)",
            "default": "<p><strong>60% off</strong> + free shipping applied!</p>"
        },
        {
            "type": "richtext",
            "id": "highlight_text_mobile",
            "label": "Highlight Text (Mobile)",
            "info": "Appears in cart summary on mobile. Use [[amount:100]] for auto-converted currency (e.g., '[[amount:100]]' becomes '$180' in USD)",
            "default": "<p><strong>60% off</strong> + free shipping applied!</p>"
        },
        {
            "type": "text",
            "id": "checkout_subtext",
            "label": "Checkout Subtext",
            "info": "Text displayed under the main checkout button.",
            "default": "if you don't like your first order it will be on us"
        },
        {
            "type": "header",
            "content": "Limited-Time Deal Banner"
        },
        {
            "type": "checkbox",
            "id": "show_limited_deal",
            "label": "Show Limited-Time Deal Banner",
            "default": true
        },
        {
            "type": "text",
            "id": "limited_deal_text",
            "label": "Limited Deal Text",
            "default": "LIMITED-TIME CRAZY DEAL"
        },
        {
            "type": "number",
            "id": "countdown_hours",
            "label": "Countdown Hours",
            "default": 0,
            "info": "Hours for countdown timer"
        },
        {
            "type": "number",
            "id": "countdown_minutes",
            "label": "Countdown Minutes",
            "default": 9,
            "info": "Minutes for countdown timer"
        },
        {
            "type": "number",
            "id": "countdown_seconds",
            "label": "Countdown Seconds",
            "default": 57,
            "info": "Seconds for countdown timer"
        },
        {
            "type": "header",
            "content": "Ultimate Hair Care Package Upsell"
        },
        {
            "type": "product",
            "id": "upsell_product",
            "label": "Upsell Product"
        },
        {
            "type": "image_picker",
            "id": "upsell_image",
            "label": "Upsell Package Image"
        },
        {
            "type": "text",
            "id": "upsell_title",
            "label": "Upsell Title",
            "default": "Ultimate Hair Care Package"
        },
        {
            "type": "richtext",
            "id": "upsell_description",
            "label": "Upsell Description",
            "default": "<p>Get all 7 products — more than our top 3 bestsellers — with <strong>50% off</strong>. This is a one-time purchase with no subscription. A limited time offer we may not keep for long</p>"
        },
        {
            "type": "text",
            "id": "upsell_button_text",
            "label": "Upsell Button Text",
            "default": "Claim Ultimate Package"
        },
        {
            "type": "text",
            "id": "upsell_fine_print",
            "label": "Upsell Fine Print",
            "default": "no subscription • One-time payment • Limited availability"
        },
        {
            "type": "number",
            "id": "upsell_discount_percent",
            "label": "Discount Percentage",
            "default": 50,
            "info": "Percentage shown in discount badge (e.g., 50 for 50%)"
        }
    ],
    "blocks": [
        {
            "type": "feature_item",
            "name": "Feature Item",
            "settings": [
                {
                    "type": "image_picker",
                    "id": "feature_icon",
                    "label": "Feature Icon"
                },
                {
                    "type": "text",
                    "id": "feature_text",
                    "label": "Feature Text",
                    "default": "Free shipping"
                }
            ]
        }
    ],
    "presets": [
        {
            "name": "Quiz Recommendations"
        }
    ]
}
{% endschema %}