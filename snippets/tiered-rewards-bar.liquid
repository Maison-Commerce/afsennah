{%- liquid
  assign cart_total = cart.total_price
  assign cart_total_dollars = cart_total | divided_by: 100.0
  
  assign free_shipping_threshold = section.settings.free_shipping_threshold
  assign tier_1_threshold = section.settings.gift_tier_1_amount
  assign tier_2_threshold = section.settings.gift_tier_2_amount
  assign tier_3_threshold = section.settings.gift_tier_3_amount
  
  assign free_shipping_achieved = false
  assign tier_1_achieved = false
  assign tier_2_achieved = false
  assign tier_3_achieved = false
  
  if cart_total_dollars >= tier_1_threshold
    assign free_shipping_achieved = true
  endif
  if cart_total_dollars >= tier_1_threshold
    assign tier_1_achieved = true
  endif
  if cart_total_dollars >= tier_2_threshold
    assign tier_2_achieved = true
  endif
  if cart_total_dollars >= tier_3_threshold
    assign tier_3_achieved = true
  endif


  assign next_tier_amount = false
  assign next_tier_label = false
  if cart_total_dollars < free_shipping_threshold
    assign next_tier_amount = free_shipping_threshold | minus: cart_total_dollars
    assign next_tier_label = 'Free shipping'
  elsif cart_total_dollars < tier_1_threshold
    assign next_tier_amount = tier_1_threshold | minus: cart_total_dollars
    assign next_tier_label = section.settings.gift_tier_1_label
  elsif cart_total_dollars < tier_2_threshold
    assign next_tier_amount = tier_2_threshold | minus: cart_total_dollars
    assign next_tier_label = section.settings.gift_tier_2_label
  elsif cart_total_dollars < tier_3_threshold
    assign next_tier_amount = tier_3_threshold | minus: cart_total_dollars
    assign next_tier_label = section.settings.gift_tier_3_label
  endif
-%}

{%- if section.settings.enable_tiered_rewards -%}
  <div class="tiered-rewards-bar{% if cart.items == empty %} tiered-rewards-bar--no-cart{% endif %}" 
       data-cart-total="{{ cart_total_dollars }}"
       data-merge-attributes="tiered-rewards">
    
    {%- if next_tier_amount and next_tier_amount > 0 -%}
      <div class="tiered-rewards-bar__banner">
        {%- if section.settings.banner_icon != blank -%}
          <span class="tiered-rewards-bar__banner-icon">
            {% render 'icon', icon: section.settings.banner_icon, size: 'small' %}
          </span>
        {%- elsif section.settings.banner_custom_icon != blank -%}
          <span class="tiered-rewards-bar__banner-icon tiered-rewards-bar__banner-icon--image">
            {%- liquid
              assign icon_sizes = '16px'
              assign icon_widths = '16, 32'
              render 'image', image: section.settings.banner_custom_icon, sizes: icon_sizes, widths: icon_widths
            -%}
          </span>
        {%- endif -%}
        <span class="tiered-rewards-bar__banner-text">
          {%- if free_shipping_achieved -%}
            {{ section.settings.banner_text_achieved | default: 'Free shipping added! Spend [AMOUNT] more to get Free [LABEL]!' | replace: '[AMOUNT]', next_tier_amount | money | replace: '[LABEL]', next_tier_label }}
          {%- else -%}
            {{ section.settings.banner_text | default: 'Spend [AMOUNT] more to get Free [LABEL]!' | replace: '[AMOUNT]', next_tier_amount | money | replace: '[LABEL]', next_tier_label }}
          {%- endif -%}
        </span>
      </div>
    {%- elsif tier_3_achieved -%}
      <div class="tiered-rewards-bar__banner tiered-rewards-bar__banner--all-achieved">
        {%- if section.settings.banner_icon != blank -%}
          <span class="tiered-rewards-bar__banner-icon">
            {% render 'icon', icon: section.settings.banner_icon, size: 'small' %}
          </span>
        {%- elsif section.settings.banner_custom_icon != blank -%}
          <span class="tiered-rewards-bar__banner-icon tiered-rewards-bar__banner-icon--image">
            {%- liquid
              assign icon_sizes = '16px'
              assign icon_widths = '16, 32'
              render 'image', image: section.settings.banner_custom_icon, sizes: icon_sizes, widths: icon_widths
            -%}
          </span>
        {%- endif -%}
        <span class="tiered-rewards-bar__banner-text">
          {{ section.settings.banner_text_all_achieved | default: 'All rewards unlocked!' }}
        </span>
      </div>
    {%- endif -%}
    
    <div class="tiered-rewards-bar__progress-grid">
      <div class="tiered-rewards-bar__progress-container" data-total="{{ cart_total_dollars }}">
        {%- comment -%} Segment 1: 0 to Free Shipping {%- endcomment -%}
        <div class="tiered-rewards-bar__segment-wrap">
          <div class="tiered-rewards-bar__segment" data-min="0" data-max="{{ free_shipping_threshold }}">
            <div class="tiered-rewards-bar__segment-fill"></div>
          </div>
        </div>
        
        {%- comment -%} Segment 2: Free Shipping to Tier 1 {%- endcomment -%}
        {%- if section.settings.gift_tier_1_label != blank -%}
          <div class="tiered-rewards-bar__segment-wrap">
            <div class="tiered-rewards-bar__segment" data-min="{{ free_shipping_threshold }}" data-max="{{ tier_1_threshold }}">
              <div class="tiered-rewards-bar__segment-fill"></div>
            </div>
          </div>
        {%- endif -%}
        
        {%- comment -%} Segment 3: Tier 1 to Tier 2 {%- endcomment -%}
        {%- if section.settings.gift_tier_2_label != blank -%}
          <div class="tiered-rewards-bar__segment-wrap">
            <div class="tiered-rewards-bar__segment" data-min="{{ tier_1_threshold }}" data-max="{{ tier_2_threshold }}">
              <div class="tiered-rewards-bar__segment-fill"></div>
            </div>
          </div>
        {%- endif -%}
        
        {%- comment -%} Segment 4: Tier 2 to Tier 3 {%- endcomment -%}
        {%- if section.settings.gift_tier_3_label != blank -%}
          <div class="tiered-rewards-bar__segment-wrap">
            <div class="tiered-rewards-bar__segment" data-min="{{ tier_2_threshold }}" data-max="{{ tier_3_threshold }}">
              <div class="tiered-rewards-bar__segment-fill"></div>
            </div>
          </div>
        {%- endif -%}
      </div>
      
      <div class="tiered-rewards-bar__markers">
        {%- comment -%} Free Shipping Marker {%- endcomment -%}
        {%- liquid
          assign free_shipping_cents = free_shipping_threshold | times: 100
        -%}
        <span class="tiered-rewards-bar__marker-image" data-index="0">
          <span class="tiered-rewards-bar__marker-icon">
            {% render 'icon', icon: 'truck', size: 'small' %}
          </span>
          <span class="tiered-rewards-bar__marker-price" data-price-cents="{{ free_shipping_cents }}">{{ free_shipping_cents | money_without_trailing_zeros }}</span>
        </span>
        
        {%- comment -%} Tier 1 Marker {%- endcomment -%}
        {%- if section.settings.gift_tier_1_label != blank -%}
          {%- liquid
            assign tier_1_cents = tier_1_threshold | times: 100
          -%}
          <span class="tiered-rewards-bar__marker-image{% if tier_1_achieved %} active{% endif %}" data-index="1">
            {%- if section.settings.gift_tier_1_image != blank -%}
              {%- liquid
                assign icon_sizes = '40px'
                assign icon_widths = '40, 80'
                render 'image', image: section.settings.gift_tier_1_image, sizes: icon_sizes, widths: icon_widths
              -%}
            {%- else -%}
              <span class="tiered-rewards-bar__marker-icon">
                {% render 'icon', icon: 'gift', size: 'small' %}
              </span>
            {%- endif -%}
            <span class="tiered-rewards-bar__marker-price" data-price-cents="{{ tier_1_cents }}">{{ tier_1_cents | money_without_trailing_zeros }}</span>
          </span>
        {%- endif -%}
        
        {%- comment -%} Tier 2 Marker {%- endcomment -%}
        {%- if section.settings.gift_tier_2_label != blank -%}
          {%- liquid
            assign tier_2_cents = tier_2_threshold | times: 100
          -%}
          <span class="tiered-rewards-bar__marker-image{% if tier_2_achieved %} active{% endif %}" data-index="2">
            {%- if section.settings.gift_tier_2_image != blank -%}
              {%- liquid
                assign icon_sizes = '40px'
                assign icon_widths = '40, 80'
                render 'image', image: section.settings.gift_tier_2_image, sizes: icon_sizes, widths: icon_widths
              -%}
            {%- else -%}
              <span class="tiered-rewards-bar__marker-icon">
                {% render 'icon', icon: 'gift', size: 'small' %}
              </span>
            {%- endif -%}
            <span class="tiered-rewards-bar__marker-price" data-price-cents="{{ tier_2_cents }}">{{ tier_2_cents | money_without_trailing_zeros }}</span>
          </span>
        {%- endif -%}
        
        {%- comment -%} Tier 3 Marker {%- endcomment -%}
        {%- if section.settings.gift_tier_3_label != blank -%}
          {%- liquid
            assign tier_3_cents = tier_3_threshold | times: 100
          -%}
          <span class="tiered-rewards-bar__marker-image{% if tier_3_achieved %} active{% endif %}" data-index="3">
            {%- if section.settings.gift_tier_3_image != blank -%}
              {%- liquid
                assign icon_sizes = '40px'
                assign icon_widths = '40, 80'
                render 'image', image: section.settings.gift_tier_3_image, sizes: icon_sizes, widths: icon_widths
              -%}
            {%- else -%}
              <span class="tiered-rewards-bar__marker-icon">
                {% render 'icon', icon: 'gift', size: 'small' %}
              </span>
            {%- endif -%}
            <span class="tiered-rewards-bar__marker-price" data-price-cents="{{ tier_3_cents }}">{{ tier_3_cents | money_without_trailing_zeros }}</span>
          </span>
        {%- endif -%}
      </div>
    </div>
  </div>

  <script>
    (function() {
      // Function to convert and format prices in user's currency
      function convertMarkerPrices() {
        const markerPrices = document.querySelectorAll('.tiered-rewards-bar__marker-price');
        
        markerPrices.forEach(function(priceEl) {
          // Get the original price in cents from data attribute
          const originalCents = parseFloat(priceEl.getAttribute('data-price-cents')) || 0;
          
          if (originalCents <= 0) return;
          
          // If we have Shopify currency conversion available
          if (typeof Shopify !== 'undefined' && Shopify.currency && Shopify.currency.rate) {
            const rate = parseFloat(Shopify.currency.rate);
            const activeCurrency = Shopify.currency.active;
            
            // Only convert if rate is not 1 (meaning user is not viewing in base currency)
            if (rate && rate !== 1) {
              // Convert from base currency to user's currency
              const convertedCents = Math.round(originalCents * rate);
              
              // Format using Shopify's money format
              const formatted = formatMoney(convertedCents, activeCurrency);
              
              // Update the price element
              priceEl.textContent = formatted;
            } else {
              // If rate is 1, just format the original amount
              const formatted = formatMoney(originalCents, activeCurrency);
              priceEl.textContent = formatted;
            }
          }
        });
      }
      
      // Helper function to format money
      function formatMoney(cents, currency) {
        const amount = cents / 100;
        try {
          return new Intl.NumberFormat('en', {
            style: 'currency',
            currency: currency || 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
          }).format(amount);
        } catch (e) {
          return (currency || 'USD') + ' ' + Math.round(amount);
        }
      }
      
      function updateProgressBar() {
        const container = document.querySelector('.tiered-rewards-bar__progress-container');
        if (!container) return;
        
        // Get current cart total from data attribute or calculate from cart
        let total = parseFloat(container.getAttribute('data-total')) || 0;
        
        // Try to get updated total from cart drawer if available
        const cartDrawer = document.querySelector('cart-drawer');
        if (cartDrawer) {
          const cartForm = cartDrawer.querySelector('cart-form');
          if (cartForm) {
            const cartTotalEl = cartForm.querySelector('[data-cart-total]');
            if (cartTotalEl) {
              total = parseFloat(cartTotalEl.getAttribute('data-cart-total')) || total;
            }
          }
        }
        
        // Update data-total attribute
        container.setAttribute('data-total', total);
        
        const segments = container.querySelectorAll('.tiered-rewards-bar__segment');
        const freeShippingThreshold = {{ free_shipping_threshold }};

        // Reset all markers
        document.querySelectorAll('.tiered-rewards-bar__marker-image').forEach(marker => {
          marker.classList.remove('active');
        });

        segments.forEach((segment, index) => {
          const min = parseFloat(segment.getAttribute('data-min')) || 0;
          const max = parseFloat(segment.getAttribute('data-max')) || 0;
          const fillEl = segment.querySelector('.tiered-rewards-bar__segment-fill');
          if (!fillEl) return;

          let fillPercent = 0;
          if (total <= min) {
            fillPercent = 0;
          } else if (total >= max) {
            fillPercent = 100;
            // Mark marker as active (index + 1 because free shipping is index 0)
            const marker = document.querySelector(`.tiered-rewards-bar__marker-image[data-index="${index + 1}"]`);
            if (marker) {
              marker.classList.add('active');
            }
          } else {
            fillPercent = ((total - min) / (max - min)) * 100;
          }

          fillPercent = Math.max(0, Math.min(100, fillPercent));
          fillEl.style.width = fillPercent + '%';
        });
        
        // Mark free shipping as active if achieved
        if (total >= freeShippingThreshold) {
          const freeShippingMarker = document.querySelector('.tiered-rewards-bar__marker-image[data-index="0"]');
          if (freeShippingMarker) {
            freeShippingMarker.classList.add('active');
          }
        }
      }

      // Run on DOMContentLoaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          updateProgressBar();
          convertMarkerPrices();
        });
      } else {
        updateProgressBar();
        convertMarkerPrices();
      }

      // Update when cart changes
      document.addEventListener('cart:updated', function() {
        updateProgressBar();
        convertMarkerPrices();
      });
      document.addEventListener('cart:refresh', function() {
        updateProgressBar();
        convertMarkerPrices();
      });
      document.addEventListener('on:cart:after-merge', function() {
        updateProgressBar();
        convertMarkerPrices();
      });
      
      // Update prices when currency changes
      if (typeof Shopify !== 'undefined' && Shopify.currency) {
        document.addEventListener('currency:change', convertMarkerPrices);
      }
      
      // Watch for mutations in cart drawer
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'data-cart-total') {
            updateProgressBar();
          }
        });
      });
      
      const tieredRewardsBar = document.querySelector('.tiered-rewards-bar');
      if (tieredRewardsBar) {
        observer.observe(tieredRewardsBar, {
          attributes: true,
          attributeFilter: ['data-cart-total'],
          subtree: true
        });
      }
    })();
  </script>
{%- endif -%}
