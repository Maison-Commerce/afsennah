{%- liquid
  assign block_index = block_index | default: 0
  assign is_last = is_last | default: false
  assign is_first_in_group = is_first_in_group | default: false
  assign video_slide_count_param = video_slide_count | default: 0
  assign video_slide_start_index_param = video_slide_start_index | default: block_index
  
  if is_first_in_group
    assign video_slide_count = 0
    assign video_slide_start_index = block_index
    for i in (block_index..section.blocks.size)
      if i < section.blocks.size
        assign check_block = section.blocks[i]
        if check_block.type == 'video_slide'
          assign video_slide_count = video_slide_count | plus: 1
        else
          break
        endif
      else
        break
      endif
    endfor
  else
    assign video_slide_count = video_slide_count_param
    assign video_slide_start_index = video_slide_start_index_param
  endif
-%}

{%- if is_first_in_group -%}
  <carousel-slider class="carousel block collection-slider video-slider__wrapper" data-dispatch-events="false">
    <div class="opposing-items opposing-items--valign-base very-lightly-spaced-row">
      <div class="opposing-items__left">
        {%- if block.settings.title != blank -%}
          <h2 class="video-slide-title" style="margin-bottom: 0; font-size: {{ block.settings.title_size | default: 24 }}px;">{{ block.settings.title }}</h2>
        {%- endif -%}
      </div>
      <div class="no-wrap slider-nav">
        <button name="prev" class="slider-nav__btn has-ltr-icon">
          <span class="visually-hidden">{{ 'general.slider.previous' | t }}</span>
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3.4286 4.57141L1.14288 6.85713M1.14288 6.85713L3.4286 9.14284M1.14288 6.85713H12.5715" stroke="#2E432F" stroke-width="0.857143" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button name="next" class="slider-nav__btn has-ltr-icon">
          <span class="visually-hidden">{{ 'general.slider.next' | t }}</span>
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g clip-path="url(#clip0_video_slider_{{ video_slide_start_index }})">
              <path d="M10.2857 4.57141L12.5715 6.85713M12.5715 6.85713L10.2857 9.14284M12.5715 6.85713H1.14288" stroke="#2E432F" stroke-width="0.857143" stroke-linecap="round" stroke-linejoin="round"/>
            </g>
            <defs>
              <clipPath id="clip0_video_slider_{{ video_slide_start_index }}">
                <rect width="13.7143" height="13.7143" fill="white"/>
              </clipPath>
            </defs>
          </svg>
        </button>
      </div>
    </div>
    <div class="slider slider--no-scrollbar slider--edge-peek">
      <ul class="slider__grid product-grid product-grid--carousel product-grid--per-row-3 product-grid--per-row-mob-3 video-slider-grid">
{%- endif -%}

<style>
  .video-slide-container {
    position: relative;
    overflow: hidden;
    border-radius: var(--video-slide-border-radius, 8px);
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .video-slide-image-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: var(--video-slide-border-radius, 8px);
    aspect-ratio: 16 / 9;
  }

  .video-slide-image {
    width: 100%;
    height: auto;
    display: block;
    border-radius: var(--video-slide-border-radius, 8px);
  }

  .video-slide-container img,
  .video-slide-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: var(--video-slide-border-radius, 8px);
  }

  .video-slide-video-wrapper {
    position: relative;
    width: 100%;
    border-radius: var(--video-slide-border-radius, 8px);
    overflow: hidden;
    aspect-ratio: 16 / 9;
  }
  
  .video-slide-video-wrapper video,
  .video-slide-video-wrapper iframe {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .video-slide-poster {
    position: relative;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }

  .video-slide-poster-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(255, 255, 255, 0.9);
    border: 0.1rem solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    color: rgb(var(--color-foreground));
    display: flex;
    align-items: center;
    justify-content: center;
    height: 6.2rem;
    width: 6.2rem;
    z-index: 1;
    transition: transform var(--duration-short, 0.3s) ease, color var(--duration-short, 0.3s) ease;
    pointer-events: none;
  }

  .video-slide-poster {
    pointer-events: auto;
    cursor: pointer;
  }

  .video-slide-poster-button--image {
    top: auto;
    left: 1rem;
    bottom: 1rem;
    transform: none;
    height: 4.4rem;
    width: 4.4rem;
    background-color: rgba(0, 0, 0, 0.6);
    border: none;
  }

  .video-slide-poster-button:hover {
    transform: translate(-50%, -50%) scale(1.1);
  }

  .video-slide-poster-button--image:hover {
    transform: scale(1.1);
    background-color: rgba(0, 0, 0, 0.8);
  }

  .video-slide-poster-button .icon {
    width: 2rem;
    height: 2rem;
  }

  .video-slide-poster-button--image .icon {
    width: 1.6rem;
    height: 1.6rem;
    color: white;
  }

  .video-slide-poster-button .icon-play {
    margin-left: 0.2rem;
  }

  .video-slide-deferred-media {
    position: relative;
    width: 100%;
    border-radius: var(--video-slide-border-radius, 8px);
    overflow: hidden;
    --ratio-percent: 56.25%;
    padding-bottom: calc(var(--ratio-percent) - var(--media-border-width, 0px));
  }

  .video-slide-deferred-media.deferred-media {
    box-shadow: var(--media-shadow-horizontal-offset) var(--media-shadow-vertical-offset) var(--media-shadow-blur-radius)
      rgba(var(--color-shadow), var(--media-shadow-opacity));
  }

  .video-slide-poster {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
  }

  .video-slide-poster img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .video-slide-deferred-media video,
  .video-slide-deferred-media iframe {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
  }

  .video-slide-deferred-media video {
    background: #000000;
    object-fit: cover;
  }

  .video-slide-container-{{ block.id }} {
    --video-slide-border-radius: {{ block.settings.border_radius | default: 8 }}px;
  }

  @media screen and (max-width: 768px) {
    .video-slide-container-{{ block.id }} {
      --video-slide-border-radius: {{ block.settings.border_radius_mobile | default: 8 }}px;
    }
  }

  /* Video slider grid styles - 3 videos per view */
  .video-slider-grid {
    --product-columns-desktop: 3;
    grid-auto-columns: calc((100% - var(--gutter) * 2) / 3);
  }

  .video-slider-grid .slider__item {
    display: flex;
    flex-direction: column;
  }

  /* Mobile styles - 3 videos per view */
  @media (max-width: 767.98px) {
    .video-slider-grid {
      --product-columns-desktop: 3;
      grid-auto-columns: calc((100% - var(--gutter) * 2) / 3);
    }
  }

  /* Video slider wrapper spacing */
  .video-slider__wrapper {
    margin-bottom: 2rem;
    overflow: hidden;
  }

  .video-slider__wrapper .slider {
    overflow: hidden;
  }

  .video-slide-title {
    margin-bottom: 1rem;
  }
</style>

<li
  id="Slide-{{ section.id }}-video-{{ block.id }}"
  class="slider__item video-slide-container video-slide-container-{{ block.id }}"
  {{ block.shopify_attributes }}
>
  {%- if block.settings.media_type == 'video' -%}
    {%- if block.settings.video != blank or block.settings.video_url != blank -%}
      {%- assign video_id = 'video-' | append: block.id -%}
      {%- if block.settings.poster_image != blank -%}
        {%- assign poster = block.settings.poster_image -%}
      {%- elsif block.settings.video != blank and block.settings.video.preview_image != blank -%}
        {%- assign poster = block.settings.video.preview_image -%}
      {%- else -%}
        {%- assign poster = null -%}
      {%- endif -%}
      <div class="video-slide-video-wrapper">
        {%- if block.settings.video != blank -%}
          {%- if poster != null -%}
            {{
              poster
              | image_url: width: 1920
              | image_tag: loading: 'lazy', alt: block.settings.alt_text, class: 'video-slide-poster-image', style: 'width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: block;'
            }}
          {%- endif -%}
          <video
            id="{{ video_id }}"
            class="video-slide-video"
            style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--video-slide-border-radius, 8px); position: absolute; top: 0; left: 0;"
            {% if poster != null %}
              poster="{{ poster | image_url: width: 1920 }}"
            {% endif %}
            preload="metadata"
            playsinline
          >
            <source src="{{ block.settings.video.sources[0].url  }}" type="{{ source.mime_type }}">
            Your browser does not support the video tag.
          </video>
          {%- if poster != null -%}
            <button
              type="button"
              class="video-slide-play-button"
              aria-label="{{ block.settings.alt_text | default: 'Play video' }}"
              tabindex="-1"
              style="position: absolute; cursor: pointer; z-index: 2;"
            >
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 6V18L17 12L7 6Z" fill="white"/>
              </svg>
            </button>
            <script>
              (function() {
                const slideElement = document.getElementById('Slide-{{ section.id }}-video-{{ block.id }}');
                const video = document.getElementById('{{ video_id }}');
                const playButton = slideElement?.querySelector('.video-slide-play-button');
                const posterImage = slideElement?.querySelector('.video-slide-poster-image');
                
                if (!slideElement || !video) return;

                function updateInteractiveElements() {
                  const isHidden = slideElement.getAttribute('aria-hidden') === 'true';
                  
                  if (playButton) {
                    playButton.setAttribute('tabindex', isHidden ? '-1' : '0');
                    if (isHidden && document.activeElement === playButton) {
                      playButton.blur();
                    }
                  }

                  const interactiveElements = video.querySelectorAll('button, input, [tabindex]');
                  interactiveElements.forEach(function(element) {
                    if (isHidden) {
                      element.setAttribute('tabindex', '-1');
                      if (document.activeElement === element) {
                        element.blur();
                      }
                    } else {
                      const originalTabindex = element.getAttribute('data-original-tabindex');
                      if (originalTabindex !== null) {
                        element.setAttribute('tabindex', originalTabindex);
                      } else if (element.hasAttribute('tabindex')) {
                        element.removeAttribute('tabindex');
                      }
                    }
                  });

                  if (isHidden) {
                    video.setAttribute('tabindex', '-1');
                    if (document.activeElement === video) {
                      video.blur();
                    }
                  } else {
                    video.removeAttribute('tabindex');
                  }
                }

                function saveOriginalTabindex() {
                  const interactiveElements = video.querySelectorAll('button, input, [tabindex]');
                  interactiveElements.forEach(function(element) {
                    if (!element.hasAttribute('data-original-tabindex')) {
                      const currentTabindex = element.getAttribute('tabindex');
                      if (currentTabindex !== null) {
                        element.setAttribute('data-original-tabindex', currentTabindex);
                      } else {
                        element.setAttribute('data-original-tabindex', '');
                      }
                    }
                  });
                }

                const observer = new MutationObserver(function() {
                  saveOriginalTabindex();
                  updateInteractiveElements();
                });
                
                observer.observe(slideElement, {
                  attributes: true,
                  attributeFilter: ['aria-hidden']
                });

                const videoObserver = new MutationObserver(function() {
                  saveOriginalTabindex();
                  updateInteractiveElements();
                });
                
                videoObserver.observe(video, {
                  childList: true,
                  subtree: true
                });

                saveOriginalTabindex();
                updateInteractiveElements();

                if (playButton) {
                  playButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    video.play();
                    playButton.style.display = 'none';
                    if (posterImage) posterImage.style.display = 'none';
                  });
                }

                const videoWrapper = slideElement.querySelector('.video-slide-video-wrapper');
                
                function handleVideoClick(e) {
                  if (playButton && playButton.contains(e.target)) {
                    return;
                  }
                  
                  e.preventDefault();
                  e.stopPropagation();
                  
                  if (video.paused || video.ended) {
                    video.play();
                    if (playButton) playButton.style.display = 'none';
                    if (posterImage) posterImage.style.display = 'none';
                  } else {
                    video.pause();
                  }
                }

                video.addEventListener('click', handleVideoClick);
                
                if (videoWrapper) {
                  videoWrapper.addEventListener('click', handleVideoClick);
                  videoWrapper.style.cursor = 'pointer';
                }

                video.addEventListener('play', function() {
                  if (playButton) playButton.style.display = 'none';
                  if (posterImage) posterImage.style.display = 'none';
                  setTimeout(updateInteractiveElements, 100);
                });

                video.addEventListener('pause', function() {
                  if (video.currentTime > 0 && !video.ended && playButton) {
                    playButton.style.display = 'flex';
                  }
                });

                video.addEventListener('ended', function() {
                  if (playButton) {
                    playButton.style.display = 'flex';
                  }
                  if (posterImage) {
                    posterImage.style.display = 'block';
                  }
                });
              })();
            </script>
          {%- endif -%}
        {%- elsif block.settings.video_url != blank -%}
          {%- liquid
            assign video_host = block.settings.video_host | default: 'youtube'
            if video_host == 'youtube'
              assign video_id_param = block.settings.video_url | split: 'v=' | last | split: '&' | first
              if block.settings.video_id != blank
                assign video_id_param = block.settings.video_id
              endif
              assign embed_url = 'https://www.youtube.com/embed/' | append: video_id_param
            elsif video_host == 'vimeo'
              assign video_id_param = block.settings.video_url | split: '/' | last | split: '?' | first
              assign embed_url = 'https://player.vimeo.com/video/' | append: video_id_param
            endif
          -%}
          <div class="video-slide-video-wrapper">
            <iframe
              src="{{ embed_url }}"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: var(--video-slide-border-radius, 8px);"
              allow="autoplay; encrypted-media"
              allowfullscreen
              loading="lazy"
            ></iframe>
          </div>
        {%- endif -%}
      </div>
    {%- endif -%}
  {%- elsif block.settings.media_type == 'image' and block.settings.image != blank -%}
    <div class="video-slide-image-wrapper" style="border-radius: var(--video-slide-border-radius, 8px);">
      {{
        block.settings.image
        | image_url: width: 1920
        | image_tag: loading: 'lazy', alt: block.settings.alt_text, class: 'video-slide-image'
      }}
      <span class="video-slide-poster-button video-slide-poster-button--image motion-reduce">
        {%- render 'icon-play' -%}
      </span>
    </div>
  {%- endif -%}
</li>

{%- if is_last or next_block == blank or next_block.type != 'video_slide' -%}
      </ul>
    </div>
  </carousel-slider>
{%- endif -%}







